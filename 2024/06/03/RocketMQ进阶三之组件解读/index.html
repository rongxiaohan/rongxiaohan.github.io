

<!DOCTYPE html>
<html lang="zh-Hans" color-mode=light>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>RocketMQè¿›é˜¶ä¸‰ä¹‹ç»„ä»¶è§£è¯» - ç¬‘å®¹+</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="google" content="notranslate" />
  <meta name="keywords" content="æŠ€æœ¯åšå®¢, Java, Python, Node.js, Web å¼€å‘">
  <meta name="description" content="RocketMQ NameServerå¯åŠ¨è¿‡ç¨‹æ¢³ç†
ï¿½...">
  <meta name="author" content="å•çº¿ç¨‹åƒåœ¾æ¸…ç†å·¥">
  <link rel="icon" href="/images/icons/favicon-16x16.png" type="image/png" sizes="16x16">
  <link rel="icon" href="/images/icons/favicon-32x32.png" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png" sizes="180x180">
  <meta rel="mask-icon" href="/images/icons/stun-logo.svg" color="#333333">
  
    <meta rel="msapplication-TileImage" content="/images/icons/favicon-144x144.png">
    <meta rel="msapplication-TileColor" content="#000000">
  

  
<link rel="stylesheet" href="/css/style.css">


  
    
<link rel="stylesheet" href="https://at.alicdn.com/t/font_1445822_p6ry5n7lrr.css">

  

  
    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

  

  
    
      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/solarized-dark.min.css" name="highlight-style" mode="light">

      
        
        
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/solarized-dark.min.css" name="highlight-style" mode="dark">

      
  

  <script>
    var CONFIG = window.CONFIG || {};
    var ZHAOO = window.ZHAOO || {};
    CONFIG = {
      isHome: false,
      fancybox: true,
      pjax: false,
      loading: {
        gif: '/images/theme/loading.gif',
        lottie: ''
      },
      lazyload: {
        enable: true,
        only_post: 'false',
        loading: {
          gif: '/images/theme/loading.gif',
          lottie: ''
        }
      },
      donate: {
        enable: false,
        alipay: 'https://pic.izhaoo.com/alipay.jpg',
        wechat: 'https://pic.izhaoo.com/wechat.jpg'
      },
      galleries: {
        enable: true
      },
      fab: {
        enable: true,
        always_show: false
      },
      carrier: {
        enable: true
      },
      daovoice: {
        enable: false
      },
      preview: {
        background: {
          default: '',
          api: ''
        },
        motto: {
          default: 'æˆ‘åœ¨å¼€äº†ç¯çš„åºŠå¤´ä¸‹ï¼Œæƒ³é—®é—®è‡ªå·±çš„å¿ƒå•Šã€‚',
          typing: true,
          api: 'https://v2.jinrishici.com/one.json',
          data_contents: '["data","content"]'
        },
      },
      qrcode: {
        enable: true,
        type: 'url',
        image: 'https://pic.izhaoo.com/weapp-code.jpg',
      },
      toc: {
        enable: true
      },
      scrollbar: {
        type: 'simple'
      },
      notification: {
        enable: false,
        delay: 4500,
        list: '',
        page_white_list: '',
        page_black_list: ''
      },
      search: {
        enable: false,
        path: ''
      }
    }
  </script>

  

  

<meta name="generator" content="Hexo 7.3.0"></head>

<body class="lock-screen">
  <div class="loading" id="loading"></div>
  
    


  <nav class="navbar">
    <div class="left">
      
        <i class="iconfont iconhome j-navbar-back-home"></i>
      
      
        <i class="iconfont iconqrcode j-navbar-qrcode"></i>
      
      
        <i class="iconfont iconmoono" id="color-toggle" color-toggle="light"></i>
      
      
    </div>
    <div class="center">RocketMQè¿›é˜¶ä¸‰ä¹‹ç»„ä»¶è§£è¯»</div>
    <div class="right">
      <i class="iconfont iconmenu j-navbar-menu"></i>
    </div>
    
      <div id="qrcode-navbar"></div>
    
  </nav>

  
  

<nav class="menu">
  <div class="menu-container">
    <div class="menu-close">
      <i class="iconfont iconbaseline-close-px"></i>
    </div>
    <ul class="menu-content"><li class="menu-item">
        <a href="/ " class="underline "> é¦–é¡µ</a>
      </li><li class="menu-item">
        <a href="/galleries/ " class="underline "> ç”Ÿæ´»</a>
      </li><li class="menu-item">
        <a href="/archives/ " class="underline "> å½’æ¡£</a>
      </li><li class="menu-item">
        <a href="/tags/ " class="underline "> æ ‡ç­¾</a>
      </li><li class="menu-item">
        <a href="/categories/ " class="underline "> åˆ†ç±»</a>
      </li><li class="menu-item">
        <a href="/about/ " class="underline "> å…³äº</a>
      </li></ul>
    
      <div class="menu-copyright"><p></p></div>
    
  </div>
</nav>
  <main id="main">
  <div class="article-wrap">
    <div class="row container">
      <div class="col-xl-3"></div>
      <div class="col-xl-6"><article class="article">
  <div class="wrap">
    <section class="head">
  <img   class="lazyload" data-original="/images/theme/post-image.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  draggable="false">
  <div class="head-mask">
    <h1 class="head-title">RocketMQè¿›é˜¶ä¸‰ä¹‹ç»„ä»¶è§£è¯»</h1>
    <div class="head-info">
      <span class="post-info-item"><i class="iconfont iconcalendar"></i>June 03, 2024</span>
      
      <span class="post-info-item"><i class="iconfont iconfont-size"></i>18487</span>
    </div>
  </div>
</section>
    <section class="main">
      <section class="content">
        
        <h1 id="RocketMQ-NameServerå¯åŠ¨è¿‡ç¨‹æ¢³ç†"><a href="#RocketMQ-NameServerå¯åŠ¨è¿‡ç¨‹æ¢³ç†" class="headerlink" title="RocketMQ NameServerå¯åŠ¨è¿‡ç¨‹æ¢³ç†"></a><strong>RocketMQ NameServerå¯åŠ¨è¿‡ç¨‹æ¢³ç†</strong></h1><hr>
<h2 id="ğŸ§©-1-å…¥å£ç±»-NamesrvStartup-main"><a href="#ğŸ§©-1-å…¥å£ç±»-NamesrvStartup-main" class="headerlink" title="ğŸ§© 1. å…¥å£ç±» NamesrvStartup.main()"></a>ğŸ§© 1. å…¥å£ç±» <code>NamesrvStartup.main()</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    start(createNamesrvController(args));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™æ˜¯æ ‡å‡†çš„å¯åŠ¨å…¥å£ï¼Œä¸»è¦åšä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li><p>åˆ›å»º NamesrvControllerï¼ˆæ ¸å¿ƒæ§åˆ¶å™¨ï¼‰</p>
</li>
<li><p>å¯åŠ¨æ§åˆ¶å™¨</p>
</li>
</ol>
<hr>
<h2 id="ğŸ”§-2-åˆ›å»º-NamesrvController"><a href="#ğŸ”§-2-åˆ›å»º-NamesrvController" class="headerlink" title="ğŸ”§ 2. åˆ›å»º NamesrvController"></a>ğŸ”§ 2. åˆ›å»º NamesrvController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NamesrvController <span class="hljs-title function_">createNamesrvController</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">NamesrvConfig</span> <span class="hljs-variable">namesrvConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamesrvConfig</span>();<br>    <span class="hljs-type">NettyServerConfig</span> <span class="hljs-variable">nettyServerConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyServerConfig</span>();<br>    nettyServerConfig.setListenPort(<span class="hljs-number">9876</span>);<br><br>    <span class="hljs-comment">// è§£æå‘½ä»¤è¡Œå‚æ•° &amp; åŠ è½½é…ç½®æ–‡ä»¶</span><br>    <span class="hljs-comment">// ...</span><br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">NamesrvController</span> <span class="hljs-variable">controller</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamesrvController</span>(namesrvConfig, nettyServerConfig);<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–</span><br>    controller.initialize();<br>    <span class="hljs-keyword">return</span> controller;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œå®Œæˆï¼š</p>
<ul>
<li><p>é…ç½®åˆå§‹åŒ–</p>
</li>
<li><p>å®ä¾‹åŒ–æ ¸å¿ƒç»„ä»¶ NamesrvController</p>
</li>
<li><p>è°ƒç”¨ <code>controller.initialize()</code> åˆå§‹åŒ–å†…éƒ¨å­ç»„ä»¶</p>
</li>
</ul>
<hr>
<h2 id="âš™ï¸-3-NamesrvController-initialize"><a href="#âš™ï¸-3-NamesrvController-initialize" class="headerlink" title="âš™ï¸ 3. NamesrvController.initialize()"></a>âš™ï¸ 3. <code>NamesrvController.initialize()</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>.kvConfigManager.load();<br><br>    <span class="hljs-built_in">this</span>.remotingServer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyRemotingServer</span>(<span class="hljs-built_in">this</span>.nettyServerConfig, <span class="hljs-built_in">this</span>.brokerHousekeepingService);<br><br>    <span class="hljs-built_in">this</span>.remotingExecutor = Executors.newFixedThreadPool(...<br>    <span class="hljs-built_in">this</span>.registerProcessor();<br><br>    <span class="hljs-built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(...);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é‡ç‚¹ï¼š</p>
<table>
<thead>
<tr>
<th>ç»„ä»¶</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>kvConfigManager.load()</code></td>
<td>åŠ è½½æœ¬åœ°é…ç½®ï¼ˆKV å­˜å‚¨ï¼‰</td>
</tr>
<tr>
<td><code>NettyRemotingServer</code></td>
<td>åˆ›å»º Netty æœåŠ¡ï¼Œç›‘å¬ç«¯å£ï¼ˆé»˜è®¤ 9876ï¼‰</td>
</tr>
<tr>
<td><code>registerProcessor()</code></td>
<td>æ³¨å†Œè¯·æ±‚å¤„ç†å™¨ï¼Œä¾‹å¦‚ <code>DefaultRequestProcessor</code></td>
</tr>
<tr>
<td><code>scheduledExecutorService</code></td>
<td>å®šæ—¶æ¸…ç†æ— æ•ˆ Brokerã€æ‰“å°è·¯ç”±ç­‰</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ-4-NamesrvController-start"><a href="#ğŸ-4-NamesrvController-start" class="headerlink" title="ğŸ 4. NamesrvController.start()"></a>ğŸ 4. <code>NamesrvController.start()</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-built_in">this</span>.remotingServer.start();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯åŠ¨ Netty ç›‘å¬æœåŠ¡ï¼Œå¯¹å¤–æä¾›æœåŠ¡ã€‚</p>
<hr>
<h2 id="ğŸ”„-åå°å®šæ—¶ä»»åŠ¡"><a href="#ğŸ”„-åå°å®šæ—¶ä»»åŠ¡" class="headerlink" title="ğŸ”„ åå°å®šæ—¶ä»»åŠ¡"></a>ğŸ”„ åå°å®šæ—¶ä»»åŠ¡</h2><p>åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ³¨å†Œäº†å¤šä¸ªå®šæ—¶ä»»åŠ¡ï¼š</p>
<ul>
<li><p>æ¸…ç†ä¸æ´»è·ƒçš„ Brokerï¼ˆ<code>scanNotActiveBroker</code>ï¼‰</p>
</li>
<li><p>æ‰“å°å½“å‰è·¯ç”±ä¿¡æ¯</p>
</li>
<li><p>æ‰“å° KV é…ç½®</p>
</li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<br>    () -&gt; NamesrvController.<span class="hljs-built_in">this</span>.routeInfoManager.scanNotActiveBroker(),<br>    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸªœ-å¯åŠ¨æµç¨‹æ€»ç»“å›¾"><a href="#ğŸªœ-å¯åŠ¨æµç¨‹æ€»ç»“å›¾" class="headerlink" title="ğŸªœ å¯åŠ¨æµç¨‹æ€»ç»“å›¾"></a>ğŸªœ å¯åŠ¨æµç¨‹æ€»ç»“å›¾</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">namesrv.sh<br>   â†“<br>NamesrvStartup.main()<br>   â†“<br>createNamesrvController()<br>   â†“<br>NamesrvController.initialize()<br>   - åŠ è½½é…ç½®<br>   - å¯åŠ¨ Netty æœåŠ¡<br>   - æ³¨å†Œå¤„ç†å™¨<br>   - å¯åŠ¨å®šæ—¶ä»»åŠ¡<br>   â†“<br>NamesrvController.start()<br>   â†“<br>NettyRemotingServer.start()<br>   â†’ ç›‘å¬ç«¯å£ 9876ï¼Œç­‰å¾… Broker æ³¨å†Œ / Producer æŸ¥è¯¢<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ’¡-ä¸€äº›ç»†èŠ‚è¡¥å……"><a href="#ğŸ’¡-ä¸€äº›ç»†èŠ‚è¡¥å……" class="headerlink" title="ğŸ’¡ ä¸€äº›ç»†èŠ‚è¡¥å……"></a>ğŸ’¡ ä¸€äº›ç»†èŠ‚è¡¥å……</h2><h3 id="1-è·¯ç”±ä¿¡æ¯çš„ç®¡ç†"><a href="#1-è·¯ç”±ä¿¡æ¯çš„ç®¡ç†" class="headerlink" title="1. è·¯ç”±ä¿¡æ¯çš„ç®¡ç†"></a>1. è·¯ç”±ä¿¡æ¯çš„ç®¡ç†</h3><p>ç”± <code>RouteInfoManager</code> è´Ÿè´£ç®¡ç† Broker çš„æ³¨å†Œä¿¡æ¯ã€Topic è·¯ç”±ç­‰ã€‚</p>
<h3 id="2-Broker-æ³¨å†ŒåŸç†"><a href="#2-Broker-æ³¨å†ŒåŸç†" class="headerlink" title="2. Broker æ³¨å†ŒåŸç†"></a>2. Broker æ³¨å†ŒåŸç†</h3><p>Broker å¯åŠ¨æ—¶ä¼šå‘é€ <code>REGISTER_BROKER</code> è¯·æ±‚ï¼ŒNameServer æ”¶åˆ°åé€šè¿‡ <code>DefaultRequestProcessor</code> å¤„ç†ï¼Œæ³¨å†Œåˆ° <code>RouteInfoManager</code>ã€‚</p>
<hr>
<h2 id="âœ…-æ€»ç»“"><a href="#âœ…-æ€»ç»“" class="headerlink" title="âœ… æ€»ç»“"></a>âœ… æ€»ç»“</h2><p>RocketMQ çš„ NameServer å¯åŠ¨è¿‡ç¨‹çœ‹ä¼¼ç®€å•ï¼Œå®åˆ™ç»†èŠ‚ä¸°å¯Œã€‚ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>è§£æé…ç½®ï¼Œåˆ›å»º NamesrvController</p>
</li>
<li><p>åˆå§‹åŒ–æ ¸å¿ƒç»„ä»¶ï¼ˆNetty æœåŠ¡ã€å®šæ—¶ä»»åŠ¡ç­‰ï¼‰</p>
</li>
<li><p>å¯åŠ¨ç›‘å¬æœåŠ¡ï¼Œæä¾›è·¯ç”±ä¸­å¿ƒèƒ½åŠ›</p>
</li>
</ol>
<h1 id="RocketMQ-Brokerå¯åŠ¨è¿‡ç¨‹æ¢³ç†"><a href="#RocketMQ-Brokerå¯åŠ¨è¿‡ç¨‹æ¢³ç†" class="headerlink" title="RocketMQ Brokerå¯åŠ¨è¿‡ç¨‹æ¢³ç†"></a><strong>RocketMQ Brokerå¯åŠ¨è¿‡ç¨‹æ¢³ç†</strong></h1><hr>
<h2 id="ğŸš€-å¯åŠ¨æµç¨‹æ€»è§ˆ"><a href="#ğŸš€-å¯åŠ¨æµç¨‹æ€»è§ˆ" class="headerlink" title="ğŸš€ å¯åŠ¨æµç¨‹æ€»è§ˆ"></a>ğŸš€ å¯åŠ¨æµç¨‹æ€»è§ˆ</h2><p>ä» <code>broker.sh</code> è„šæœ¬è¿›å…¥ï¼Œæœ€ç»ˆä¼šå¯åŠ¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">org.apache.rocketmq.broker.BrokerStartup<br></code></pre></td></tr></table></figure>

<p>å®Œæ•´å¯åŠ¨æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">broker.sh<br>   â†“<br>BrokerStartup.main()<br>   â†“<br>createBrokerController()<br>   â†“<br>BrokerController.initialize()<br>   â†“<br>BrokerController.start()<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ§©-1-BrokerStartup-main"><a href="#ğŸ§©-1-BrokerStartup-main" class="headerlink" title="ğŸ§© 1. BrokerStartup.main()"></a>ğŸ§© 1. <code>BrokerStartup.main()</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    start(createBrokerController(args));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li><p>åˆ›å»º BrokerControllerï¼ˆæ ¸å¿ƒæ§åˆ¶å™¨ï¼‰</p>
</li>
<li><p>å¯åŠ¨å®ƒï¼</p>
</li>
</ol>
<hr>
<h2 id="âš™ï¸-2-createBrokerController-args"><a href="#âš™ï¸-2-createBrokerController-args" class="headerlink" title="âš™ï¸ 2. createBrokerController(args)"></a>âš™ï¸ 2. <code>createBrokerController(args)</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> BrokerController <span class="hljs-title function_">createBrokerController</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-comment">// è§£æé…ç½®é¡¹</span><br>    <span class="hljs-type">BrokerConfig</span> <span class="hljs-variable">brokerConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokerConfig</span>();<br>    <span class="hljs-type">NettyServerConfig</span> <span class="hljs-variable">nettyServerConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyServerConfig</span>();<br>    <span class="hljs-type">NettyClientConfig</span> <span class="hljs-variable">nettyClientConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyClientConfig</span>();<br>    <span class="hljs-type">MessageStoreConfig</span> <span class="hljs-variable">messageStoreConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageStoreConfig</span>();<br><br>    <span class="hljs-comment">// ä»é…ç½®æ–‡ä»¶åŠ è½½å±æ€§</span><br>    <span class="hljs-comment">// ...</span><br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">BrokerController</span> <span class="hljs-variable">controller</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokerController</span>(<br>        brokerConfig,<br>        nettyServerConfig,<br>        nettyClientConfig,<br>        messageStoreConfig,<br>        <span class="hljs-comment">// è¿˜æœ‰å…¶ä»–é…ç½®...</span><br>    );<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–</span><br>    controller.initialize();<br>    <span class="hljs-keyword">return</span> controller;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ„é€ äº†å„ç§é…ç½®å¯¹è±¡ï¼Œç»„åˆæˆ <code>BrokerController</code> æ§åˆ¶å™¨å¯¹è±¡ï¼Œå¹¶åˆå§‹åŒ–ã€‚</p>
<hr>
<h2 id="ğŸ”§-3-BrokerController-initialize"><a href="#ğŸ”§-3-BrokerController-initialize" class="headerlink" title="ğŸ”§ 3. BrokerController.initialize()"></a>ğŸ”§ 3. <code>BrokerController.initialize()</code></h2><p>è¿™ä¸ªæ–¹æ³•æ˜¯å¯åŠ¨é€»è¾‘çš„æ ¸å¿ƒï¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException &#123;<br>    <span class="hljs-comment">// åŠ è½½ Topic é…ç½®</span><br>    <span class="hljs-built_in">this</span>.topicConfigManager.load();<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–æ¶ˆæ¯å­˜å‚¨ç»„ä»¶</span><br>    <span class="hljs-built_in">this</span>.messageStore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMessageStore</span>(...);<br>    <span class="hljs-built_in">this</span>.messageStore.load();<br><br>    <span class="hljs-comment">// å¯åŠ¨ Netty æœåŠ¡ç«¯ï¼ˆæ¥æ”¶ Producer/Consumer è¯·æ±‚ï¼‰</span><br>    <span class="hljs-built_in">this</span>.remotingServer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyRemotingServer</span>(...);<br>    <span class="hljs-built_in">this</span>.registerProcessor();<br><br>    <span class="hljs-comment">// å¯åŠ¨ Netty å®¢æˆ·ç«¯ï¼ˆæ³¨å†Œ NameServer ç”¨ï¼‰</span><br>    <span class="hljs-built_in">this</span>.brokerOuterAPI = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokerOuterAPI</span>(nettyClientConfig);<br><br>    <span class="hljs-comment">// å®šæ—¶ä»»åŠ¡ï¼šå‘ NameServer æ³¨å†Œ</span><br>    <span class="hljs-built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(...);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸»è¦åšçš„äº‹æƒ…ï¼š</p>
<table>
<thead>
<tr>
<th>æ¨¡å—</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>topicConfigManager</code></td>
<td>åŠ è½½ Topic å’Œé˜Ÿåˆ—é…ç½®</td>
</tr>
<tr>
<td><code>DefaultMessageStore</code></td>
<td>åˆå§‹åŒ–å­˜å‚¨å¼•æ“ï¼ˆCommitLog, ConsumeQueueï¼‰</td>
</tr>
<tr>
<td><code>NettyRemotingServer</code></td>
<td>å¯åŠ¨æœåŠ¡ç«¯ï¼Œç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚</td>
</tr>
<tr>
<td><code>BrokerOuterAPI</code></td>
<td>Netty å®¢æˆ·ç«¯ï¼Œç”¨äºä¸ NameServer é€šä¿¡</td>
</tr>
<tr>
<td>å®šæ—¶æ³¨å†Œä»»åŠ¡</td>
<td>å®šæ—¶å‘ NameServer å‘é€ <code>REGISTER_BROKER</code> è¯·æ±‚</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ-4-BrokerController-start"><a href="#ğŸ-4-BrokerController-start" class="headerlink" title="ğŸ 4. BrokerController.start()"></a>ğŸ 4. <code>BrokerController.start()</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.messageStore != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-built_in">this</span>.messageStore.start();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.remotingServer != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-built_in">this</span>.remotingServer.start();<br>    &#125;<br>    <span class="hljs-built_in">this</span>.startScheduleService();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é‡ç‚¹ï¼š</p>
<ul>
<li><p>å¯åŠ¨æ¶ˆæ¯å­˜å‚¨å¼•æ“ï¼ˆè°ƒåº¦åˆ·ç›˜ã€ç´¢å¼•é‡å»ºç­‰ï¼‰</p>
</li>
<li><p>å¯åŠ¨ Netty æœåŠ¡</p>
</li>
<li><p>å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚ Broker çŠ¶æ€ä¸ŠæŠ¥ã€æ³¨å†Œä»»åŠ¡ï¼‰</p>
</li>
</ul>
<hr>
<h2 id="ğŸ”-æ³¨å†Œåˆ°-NameServer"><a href="#ğŸ”-æ³¨å†Œåˆ°-NameServer" class="headerlink" title="ğŸ” æ³¨å†Œåˆ° NameServer"></a>ğŸ” æ³¨å†Œåˆ° NameServer</h2><p>æ³¨å†ŒåŠ¨ä½œå‘ç”Ÿåœ¨ <code>BrokerController.initialize()</code> é‡Œå®šæ—¶ä»»åŠ¡ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<br>    () -&gt; <span class="hljs-built_in">this</span>.registerBrokerAll(<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>),<br>    <span class="hljs-number">1000</span>, <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>, TimeUnit.MILLISECONDS<br>);<br></code></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>Broker å¯åŠ¨åä¼šæ¯éš” 30 ç§’å‘æ‰€æœ‰ NameServer æ³¨å†Œä¸€æ¬¡</strong>ã€‚</p>
<h3 id="æ³¨å†Œåšäº†ä»€ä¹ˆï¼Ÿ"><a href="#æ³¨å†Œåšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ³¨å†Œåšäº†ä»€ä¹ˆï¼Ÿ"></a>æ³¨å†Œåšäº†ä»€ä¹ˆï¼Ÿ</h3><p>å‘é€ <code>REGISTER_BROKER</code> è¯·æ±‚ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><p>Broker åç§°ã€IDã€IPã€ç«¯å£</p>
</li>
<li><p>æ”¯æŒçš„ Topic ä¿¡æ¯</p>
</li>
<li><p>æ˜¯å¦æ˜¯ Master &#x2F; Slave</p>
</li>
<li><p>æƒé‡ã€å†™æƒé™ç­‰</p>
</li>
</ul>
<hr>
<h2 id="ğŸ’¾-æ¶ˆæ¯å­˜å‚¨ç»„ä»¶-DefaultMessageStore"><a href="#ğŸ’¾-æ¶ˆæ¯å­˜å‚¨ç»„ä»¶-DefaultMessageStore" class="headerlink" title="ğŸ’¾ æ¶ˆæ¯å­˜å‚¨ç»„ä»¶ DefaultMessageStore"></a>ğŸ’¾ æ¶ˆæ¯å­˜å‚¨ç»„ä»¶ DefaultMessageStore</h2><p>åˆå§‹åŒ–å­˜å‚¨æ˜¯ Broker å¯åŠ¨çš„å…³é”®æ­¥éª¤ï¼Œæ¶‰åŠï¼š</p>
<ul>
<li><p><strong>CommitLog</strong>ï¼šå†™å…¥æ¶ˆæ¯çš„é¡ºåºæ—¥å¿—æ–‡ä»¶</p>
</li>
<li><p><strong>ConsumeQueue</strong>ï¼šæ¶ˆæ¯æ¶ˆè´¹é˜Ÿåˆ—ç´¢å¼•</p>
</li>
<li><p><strong>IndexFile</strong>ï¼šå…³é”®è¯ç´¢å¼•</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.messageStore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMessageStore</span>(...);<br><span class="hljs-built_in">this</span>.messageStore.load();<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸€æ­¥ä¼šå°è¯•ä»ç£ç›˜æ¢å¤ä¹‹å‰çš„æ¶ˆæ¯å­˜å‚¨ç»“æ„ã€‚</p>
<hr>
<h2 id="ğŸ§ -å¯åŠ¨æµç¨‹å›¾æ€»ç»“"><a href="#ğŸ§ -å¯åŠ¨æµç¨‹å›¾æ€»ç»“" class="headerlink" title="ğŸ§  å¯åŠ¨æµç¨‹å›¾æ€»ç»“"></a>ğŸ§  å¯åŠ¨æµç¨‹å›¾æ€»ç»“</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">broker.sh<br>   â†“<br>BrokerStartup.main()<br>   â†“<br>createBrokerController()<br>   â†“<br>BrokerController.initialize()<br>   - åŠ è½½ Topic é…ç½®<br>   - åˆå§‹åŒ–æ¶ˆæ¯å­˜å‚¨å¼•æ“<br>   - å¯åŠ¨ Netty æœåŠ¡<br>   - åˆ›å»º NameServer å®¢æˆ·ç«¯<br>   - å¯åŠ¨æ³¨å†Œä»»åŠ¡<br>   â†“<br>BrokerController.start()<br>   - å¯åŠ¨æ¶ˆæ¯å­˜å‚¨è°ƒåº¦<br>   - å¯åŠ¨æœåŠ¡ç«¯ç›‘å¬<br>   - å¯åŠ¨åå°ä»»åŠ¡<br></code></pre></td></tr></table></figure>
<h1 id="RocketMQ-NettyæœåŠ¡æ³¨å†Œæ¡†æ¶"><a href="#RocketMQ-NettyæœåŠ¡æ³¨å†Œæ¡†æ¶" class="headerlink" title="RocketMQ NettyæœåŠ¡æ³¨å†Œæ¡†æ¶"></a><strong>RocketMQ NettyæœåŠ¡æ³¨å†Œæ¡†æ¶</strong></h1><hr>
<h2 id="ğŸš€-1-RocketMQ-çš„æœåŠ¡æ³¨å†Œæ¡†æ¶ç»„æˆ"><a href="#ğŸš€-1-RocketMQ-çš„æœåŠ¡æ³¨å†Œæ¡†æ¶ç»„æˆ" class="headerlink" title="ğŸš€ 1. RocketMQ çš„æœåŠ¡æ³¨å†Œæ¡†æ¶ç»„æˆ"></a>ğŸš€ 1. RocketMQ çš„æœåŠ¡æ³¨å†Œæ¡†æ¶ç»„æˆ</h2><p>RocketMQ ä¸æ˜¯ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œè€Œæ˜¯è‡ªå·±æ„å»ºäº†ä¸€ä¸ªè½»é‡çº§çš„æ³¨å†Œä¸­å¿ƒï¼š</p>
<table>
<thead>
<tr>
<th>è§’è‰²</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td><strong>NameServer</strong></td>
<td>ç±»ä¼¼è½»é‡çº§ ZooKeeperï¼Œè´Ÿè´£è·¯ç”±æ³¨å†Œå’ŒæŸ¥è¯¢</td>
</tr>
<tr>
<td><strong>Broker</strong></td>
<td>å¯åŠ¨åå‘ NameServer æ³¨å†Œè·¯ç”±ä¿¡æ¯ï¼ˆé€šè¿‡ Nettyï¼‰</td>
</tr>
<tr>
<td><strong>Client</strong></td>
<td>Producer å’Œ Consumerï¼Œä» NameServer æŸ¥è¯¢è·¯ç”±</td>
</tr>
<tr>
<td><strong>Netty</strong></td>
<td>æ‰€æœ‰è§’è‰²ä¹‹é—´çš„é€šä¿¡å±‚ï¼Œè´Ÿè´£ä¼ è¾“ã€ç¼–è§£ç ã€äº‹ä»¶ç®¡ç†</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ§©-2-NameServer-çš„æ³¨å†Œæœºåˆ¶ï¼ˆè‡ªç ”ï¼‰"><a href="#ğŸ§©-2-NameServer-çš„æ³¨å†Œæœºåˆ¶ï¼ˆè‡ªç ”ï¼‰" class="headerlink" title="ğŸ§© 2. NameServer çš„æ³¨å†Œæœºåˆ¶ï¼ˆè‡ªç ”ï¼‰"></a>ğŸ§© 2. NameServer çš„æ³¨å†Œæœºåˆ¶ï¼ˆè‡ªç ”ï¼‰</h2><p>NameServer æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª <strong>æ— çŠ¶æ€çš„è·¯ç”±æœåŠ¡ä¸­å¿ƒ</strong>ï¼š</p>
<ul>
<li><p>ä½¿ç”¨ Netty æä¾›çš„ <strong>ServerBootstrap</strong> ç›‘å¬ç«¯å£ï¼ˆé»˜è®¤ <code>9876</code>ï¼‰</p>
</li>
<li><p>æ¥æ”¶ Broker æ³¨å†Œè¯·æ±‚ï¼ˆ<code>REGISTER_BROKER</code>ï¼‰</p>
</li>
<li><p>å­˜å‚¨è·¯ç”±ä¿¡æ¯åœ¨å†…å­˜ä¸­çš„ <code>RouteInfoManager</code> é‡Œ</p>
</li>
</ul>
<p>ğŸ‘‰ æ²¡æœ‰ä¾èµ– ZooKeeperï¼Œ<strong>ä¸éœ€è¦é›†ç¾¤ä¸€è‡´æ€§åè®®</strong>ï¼ˆå¦‚ Raft æˆ– Paxosï¼‰</p>
<hr>
<h2 id="ğŸ§ -3-Broker-æ³¨å†Œ-NameServer-æµç¨‹ï¼ˆåŸºäº-Nettyï¼‰"><a href="#ğŸ§ -3-Broker-æ³¨å†Œ-NameServer-æµç¨‹ï¼ˆåŸºäº-Nettyï¼‰" class="headerlink" title="ğŸ§  3. Broker æ³¨å†Œ NameServer æµç¨‹ï¼ˆåŸºäº Nettyï¼‰"></a>ğŸ§  3. Broker æ³¨å†Œ NameServer æµç¨‹ï¼ˆåŸºäº Nettyï¼‰</h2><h3 id="Broker-å¯åŠ¨æ—¶ä¼šå®šæ—¶æ³¨å†Œï¼š"><a href="#Broker-å¯åŠ¨æ—¶ä¼šå®šæ—¶æ³¨å†Œï¼š" class="headerlink" title="Broker å¯åŠ¨æ—¶ä¼šå®šæ—¶æ³¨å†Œï¼š"></a>Broker å¯åŠ¨æ—¶ä¼šå®šæ—¶æ³¨å†Œï¼š</h3><p>åœ¨ <code>BrokerController</code> ä¸­æ³¨å†Œä»»åŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<br>    () -&gt; <span class="hljs-built_in">this</span>.registerBrokerAll(<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>),<br>    <span class="hljs-number">1000</span>, <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>, TimeUnit.MILLISECONDS<br>);<br></code></pre></td></tr></table></figure>

<h3 id="æ³¨å†Œæ–¹æ³•æ ¸å¿ƒé€»è¾‘ï¼š"><a href="#æ³¨å†Œæ–¹æ³•æ ¸å¿ƒé€»è¾‘ï¼š" class="headerlink" title="æ³¨å†Œæ–¹æ³•æ ¸å¿ƒé€»è¾‘ï¼š"></a>æ³¨å†Œæ–¹æ³•æ ¸å¿ƒé€»è¾‘ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RegisterBrokerResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.brokerOuterAPI.registerBrokerAll(<br>    clusterName,<br>    brokerAddr,<br>    brokerName,<br>    brokerId,<br>    haServerAddr,<br>    topicConfigWrapper,<br>    filterServerList,<br>    oneway,<br>    enableActingMaster,<br>    compressedRegister,<br>    timeoutMills<br>);<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸€è°ƒç”¨é€šè¿‡ Netty å®¢æˆ·ç«¯å‘é€è¯·æ±‚ã€‚</p>
<hr>
<h2 id="ğŸ”§-4-Netty-åœ¨-RocketMQ-ä¸­çš„ä½¿ç”¨æ–¹å¼"><a href="#ğŸ”§-4-Netty-åœ¨-RocketMQ-ä¸­çš„ä½¿ç”¨æ–¹å¼" class="headerlink" title="ğŸ”§ 4. Netty åœ¨ RocketMQ ä¸­çš„ä½¿ç”¨æ–¹å¼"></a>ğŸ”§ 4. Netty åœ¨ RocketMQ ä¸­çš„ä½¿ç”¨æ–¹å¼</h2><table>
<thead>
<tr>
<th>è§’è‰²</th>
<th>Netty ç»„ä»¶</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>NameServer</td>
<td><code>NettyRemotingServer</code></td>
<td>æ¥æ”¶ Broker æ³¨å†Œè¯·æ±‚</td>
</tr>
<tr>
<td>Broker</td>
<td><code>NettyRemotingServer</code> + <code>NettyRemotingClient</code></td>
<td>å¯¹å†…æ¥ Producer&#x2F;Consumerï¼Œè¯·æ±‚ NameServer</td>
</tr>
<tr>
<td>Client</td>
<td><code>NettyRemotingClient</code></td>
<td>è¯·æ±‚ NameServer è·å–è·¯ç”±</td>
</tr>
</tbody></table>
<p><strong>NettyRemotingServer</strong> å’Œ <strong>NettyRemotingClient</strong> æ˜¯ RocketMQ è‡ªå®šä¹‰çš„ Netty é€šä¿¡å°è£…ç±»ã€‚</p>
<p>å®ƒä»¬åŸºäº Netty 4.xï¼Œå°è£…äº†ï¼š</p>
<ul>
<li><p><code>RemotingCommand</code>ï¼šRocketMQ è‡ªå®šä¹‰åè®®</p>
</li>
<li><p>ç¼–è§£ç ï¼ˆHeader + Bodyï¼‰</p>
</li>
<li><p>è¯·æ±‚å¤„ç†å™¨æœºåˆ¶ï¼ˆç±»ä¼¼ Dubbo çš„ <code>ChannelHandler</code>ï¼‰</p>
</li>
</ul>
<hr>
<h2 id="âœ‰ï¸-5-æ³¨å†Œè¯·æ±‚åè®®ï¼ˆREGISTER-BROKERï¼‰"><a href="#âœ‰ï¸-5-æ³¨å†Œè¯·æ±‚åè®®ï¼ˆREGISTER-BROKERï¼‰" class="headerlink" title="âœ‰ï¸ 5. æ³¨å†Œè¯·æ±‚åè®®ï¼ˆREGISTER_BROKERï¼‰"></a>âœ‰ï¸ 5. æ³¨å†Œè¯·æ±‚åè®®ï¼ˆREGISTER_BROKERï¼‰</h2><p>RocketMQ ä½¿ç”¨è‡ªå®šä¹‰åè®® <code>RemotingCommand</code>ï¼Œå¹¶å®šä¹‰äº†æ³¨å†Œè¯·æ±‚ç±»å‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">RequestCode.REGISTER_BROKER<br></code></pre></td></tr></table></figure>

<p>å¤„ç†æµç¨‹ï¼š</p>
<ul>
<li><p>Netty æœåŠ¡ç«¯ï¼ˆNameServerï¼‰æ¥æ”¶åˆ° REGISTER_BROKER è¯·æ±‚</p>
</li>
<li><p>è°ƒç”¨å¤„ç†å™¨ <code>DefaultRequestProcessor</code></p>
</li>
<li><p>è°ƒç”¨ <code>RouteInfoManager.registerBroker(...)</code> æ³¨å†Œ Broker ä¿¡æ¯</p>
</li>
<li><p>æ›´æ–°å†…å­˜ä¸­çš„ topicã€brokerã€é˜Ÿåˆ—ä¿¡æ¯</p>
</li>
</ul>
<hr>
<h2 id="ğŸ—‚ï¸-6-NameServer-å†…å­˜ç»“æ„ï¼ˆæ³¨å†Œç»“æœçš„è½åœ°ï¼‰"><a href="#ğŸ—‚ï¸-6-NameServer-å†…å­˜ç»“æ„ï¼ˆæ³¨å†Œç»“æœçš„è½åœ°ï¼‰" class="headerlink" title="ğŸ—‚ï¸ 6. NameServer å†…å­˜ç»“æ„ï¼ˆæ³¨å†Œç»“æœçš„è½åœ°ï¼‰"></a>ğŸ—‚ï¸ 6. NameServer å†…å­˜ç»“æ„ï¼ˆæ³¨å†Œç»“æœçš„è½åœ°ï¼‰</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">RouteInfoManager &#123;<br>  HashMap&lt;String /* topic */, List&lt;QueueData&gt;&gt;<br>  HashMap&lt;String /* brokerName */, BrokerData&gt;<br>  HashMap&lt;String /* clusterName */, Set&lt;brokerName&gt;&gt;<br>  HashMap&lt;String /* brokerAddr */, BrokerLiveInfo&gt;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™äº›ä¿¡æ¯å­˜åœ¨ NameServer å†…å­˜ä¸­ï¼Œæ¯æ¬¡é‡å¯å³ä¸¢å¤±ï¼Œä½†ç”±äº <strong>Broker å®šæ—¶æ³¨å†Œ</strong>ï¼Œå¯ä»¥å¿«é€Ÿæ¢å¤ã€‚</p>
<hr>
<h2 id="ğŸ¯-å°ç»“ï¼šRocketMQ-è‡ªç ”çš„-Netty-æœåŠ¡æ³¨å†Œæ¡†æ¶"><a href="#ğŸ¯-å°ç»“ï¼šRocketMQ-è‡ªç ”çš„-Netty-æœåŠ¡æ³¨å†Œæ¡†æ¶" class="headerlink" title="ğŸ¯ å°ç»“ï¼šRocketMQ è‡ªç ”çš„ Netty æœåŠ¡æ³¨å†Œæ¡†æ¶"></a>ğŸ¯ å°ç»“ï¼šRocketMQ è‡ªç ”çš„ Netty æœåŠ¡æ³¨å†Œæ¡†æ¶</h2><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>RocketMQ çš„åšæ³•</th>
</tr>
</thead>
<tbody><tr>
<td>æœåŠ¡æ³¨å†Œä¸­å¿ƒ</td>
<td>è‡ªç ” NameServer</td>
</tr>
<tr>
<td>é€šä¿¡æ–¹å¼</td>
<td>åŸºäº Netty è‡ªå®šä¹‰åè®®</td>
</tr>
<tr>
<td>æ³¨å†Œæ¨¡å¼</td>
<td>Broker ä¸»åŠ¨å®šæ—¶æ³¨å†Œ</td>
</tr>
<tr>
<td>è·¯ç”±å‘ç°</td>
<td>Client ä¸»åŠ¨æ‹‰å–è·¯ç”±</td>
</tr>
<tr>
<td>æ•°æ®ä¸€è‡´æ€§</td>
<td>æ— çŠ¶æ€ï¼Œæœ€ç»ˆä¸€è‡´æ€§ï¼ˆä¾èµ–å®šæ—¶æ³¨å†Œï¼‰</td>
</tr>
<tr>
<td>æ˜“æ‰©å±•æ€§</td>
<td>é«˜ï¼Œå¯åŠ¨æ€å¢å‡ Broker&#x2F;Topic</td>
</tr>
</tbody></table>
<h1 id="RocketMQ-Brokerå¿ƒè·³æ³¨å†Œç®¡ç†"><a href="#RocketMQ-Brokerå¿ƒè·³æ³¨å†Œç®¡ç†" class="headerlink" title="RocketMQ Brokerå¿ƒè·³æ³¨å†Œç®¡ç†"></a><strong>RocketMQ Brokerå¿ƒè·³æ³¨å†Œç®¡ç†</strong></h1><hr>
<h2 id="ğŸ¯-ç›®æ ‡ï¼šBroker-å’Œ-NameServer-å¦‚ä½•ä¿æŒâ€œåœ¨çº¿æ„ŸçŸ¥â€"><a href="#ğŸ¯-ç›®æ ‡ï¼šBroker-å’Œ-NameServer-å¦‚ä½•ä¿æŒâ€œåœ¨çº¿æ„ŸçŸ¥â€" class="headerlink" title="ğŸ¯ ç›®æ ‡ï¼šBroker å’Œ NameServer å¦‚ä½•ä¿æŒâ€œåœ¨çº¿æ„ŸçŸ¥â€"></a>ğŸ¯ ç›®æ ‡ï¼šBroker å’Œ NameServer å¦‚ä½•ä¿æŒâ€œåœ¨çº¿æ„ŸçŸ¥â€</h2><p>RocketMQ ä½¿ç”¨ä¸¤ç§æ–¹å¼æ¥ç»´æŠ¤ Broker çŠ¶æ€ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹å¼</th>
<th>ä½œç”¨</th>
<th>ä¸»ä½“</th>
</tr>
</thead>
<tbody><tr>
<td>âœ… <strong>Broker å®šæ—¶æ³¨å†Œ</strong></td>
<td>ä¸»åŠ¨ä¸ŠæŠ¥è‡ªå·±å’Œ topic è·¯ç”±ä¿¡æ¯</td>
<td>Broker</td>
</tr>
<tr>
<td>âœ… <strong>NameServer å®šæ—¶æ¸…ç†</strong></td>
<td>æ£€æŸ¥å¤±è” Brokerï¼Œæ¸…é™¤è·¯ç”±</td>
<td>NameServer</td>
</tr>
</tbody></table>
<p>è¿™æ˜¯ä¸€ç§ <strong>å¼±å¿ƒè·³ + æ³¨å†Œä¿æ´»</strong> æœºåˆ¶ã€‚</p>
<hr>
<h2 id="ğŸ§©-ä¸€ã€Broker-å®šæ—¶æ³¨å†Œæœºåˆ¶ï¼ˆå¿ƒè·³å¼æ³¨å†Œï¼‰"><a href="#ğŸ§©-ä¸€ã€Broker-å®šæ—¶æ³¨å†Œæœºåˆ¶ï¼ˆå¿ƒè·³å¼æ³¨å†Œï¼‰" class="headerlink" title="ğŸ§© ä¸€ã€Broker å®šæ—¶æ³¨å†Œæœºåˆ¶ï¼ˆå¿ƒè·³å¼æ³¨å†Œï¼‰"></a>ğŸ§© ä¸€ã€Broker å®šæ—¶æ³¨å†Œæœºåˆ¶ï¼ˆå¿ƒè·³å¼æ³¨å†Œï¼‰</h2><h3 id="æ³¨å†Œä»»åŠ¡åœ¨-Broker-åˆå§‹åŒ–æ—¶è®¾ç½®ï¼š"><a href="#æ³¨å†Œä»»åŠ¡åœ¨-Broker-åˆå§‹åŒ–æ—¶è®¾ç½®ï¼š" class="headerlink" title="æ³¨å†Œä»»åŠ¡åœ¨ Broker åˆå§‹åŒ–æ—¶è®¾ç½®ï¼š"></a>æ³¨å†Œä»»åŠ¡åœ¨ Broker åˆå§‹åŒ–æ—¶è®¾ç½®ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<br>    () -&gt; <span class="hljs-built_in">this</span>.registerBrokerAll(<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>),<br>    <span class="hljs-number">1000</span>, <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>, TimeUnit.MILLISECONDS<br>);<br></code></pre></td></tr></table></figure>

<h3 id="æ¯-30-ç§’-å‘æ‰€æœ‰-NameServer-å‘é€-REGISTER-BROKER-è¯·æ±‚"><a href="#æ¯-30-ç§’-å‘æ‰€æœ‰-NameServer-å‘é€-REGISTER-BROKER-è¯·æ±‚" class="headerlink" title="æ¯ 30 ç§’ å‘æ‰€æœ‰ NameServer å‘é€ REGISTER_BROKER è¯·æ±‚"></a>æ¯ 30 ç§’ å‘æ‰€æœ‰ NameServer å‘é€ <code>REGISTER_BROKER</code> è¯·æ±‚</h3><p>æ ¸å¿ƒç±»ï¼š<code>BrokerOuterAPI#registerBrokerAll(...)</code></p>
<p>æ³¨å†Œä¿¡æ¯åŒ…æ‹¬ï¼š</p>
<ul>
<li><p>Broker name &#x2F; ID &#x2F; IP</p>
</li>
<li><p>Broker åœ°å€å’Œ HA åœ°å€</p>
</li>
<li><p>Topic é…ç½®ï¼ˆtopic + queue æ•°é‡ï¼‰</p>
</li>
<li><p>æ˜¯å¦æ˜¯ä¸»èŠ‚ç‚¹ã€å†™æƒé™ç­‰</p>
</li>
</ul>
<hr>
<h2 id="ğŸ§ -äºŒã€NameServer-å¤„ç†æ³¨å†Œçš„æµç¨‹"><a href="#ğŸ§ -äºŒã€NameServer-å¤„ç†æ³¨å†Œçš„æµç¨‹" class="headerlink" title="ğŸ§  äºŒã€NameServer å¤„ç†æ³¨å†Œçš„æµç¨‹"></a>ğŸ§  äºŒã€NameServer å¤„ç†æ³¨å†Œçš„æµç¨‹</h2><p>NameServer é€šè¿‡ <code>DefaultRequestProcessor</code> å¤„ç†æ³¨å†Œè¯·æ±‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> REGISTER_BROKER:<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.registerBroker(ctx, request);<br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>RouteInfoManager#registerBroker(...)</code> ä¸­ï¼š</p>
<ol>
<li><p>å°† Broker ä¿¡æ¯å­˜å…¥å†…å­˜</p>
</li>
<li><p>æ›´æ–° <code>topicQueueTable</code></p>
</li>
<li><p>åˆ›å»º&#x2F;åˆ·æ–° <code>BrokerLiveInfo</code>ï¼ˆç›¸å½“äºå¿ƒè·³æ—¶é—´æˆ³ï¼‰</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">BrokerLiveInfo</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.brokerLiveTable.put(<br>    brokerAddr,<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokerLiveInfo</span>(<br>        System.currentTimeMillis(), <span class="hljs-comment">// ä¸Šæ¬¡æ³¨å†Œæ—¶é—´</span><br>        dataVersion,<br>        channel,<br>        haServerAddr<br>    )<br>);<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ”-ä¸‰ã€å¿ƒè·³è¶…æ—¶æ£€æŸ¥ï¼ˆNameServer-æ¸…ç†æ­»æ‰çš„-Brokerï¼‰"><a href="#ğŸ”-ä¸‰ã€å¿ƒè·³è¶…æ—¶æ£€æŸ¥ï¼ˆNameServer-æ¸…ç†æ­»æ‰çš„-Brokerï¼‰" class="headerlink" title="ğŸ” ä¸‰ã€å¿ƒè·³è¶…æ—¶æ£€æŸ¥ï¼ˆNameServer æ¸…ç†æ­»æ‰çš„ Brokerï¼‰"></a>ğŸ” ä¸‰ã€å¿ƒè·³è¶…æ—¶æ£€æŸ¥ï¼ˆNameServer æ¸…ç†æ­»æ‰çš„ Brokerï¼‰</h2><p>NameServer ä¹Ÿæœ‰è‡ªå·±çš„å®šæ—¶ä»»åŠ¡ï¼ˆåœ¨ <code>NamesrvController#initialize()</code> ä¸­ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.scheduledExecutorService.scheduleAtFixedRate(<br>    () -&gt; <span class="hljs-built_in">this</span>.routeInfoManager.scanNotActiveBroker(),<br>    <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS<br>);<br></code></pre></td></tr></table></figure>

<p>æ¯ 10 ç§’æ‰«æä¸€é Brokerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (System.currentTimeMillis() - brokerLiveInfo.getLastUpdateTimestamp() &gt; BROKER_CHANNEL_EXPIRED_TIME) &#123;<br>    <span class="hljs-comment">// é»˜è®¤æ˜¯ 2 åˆ†é’Ÿ</span><br>    <span class="hljs-built_in">this</span>.onChannelDestroy(brokerAddr, channel);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="é»˜è®¤è¿‡æœŸæ—¶é—´ï¼š"><a href="#é»˜è®¤è¿‡æœŸæ—¶é—´ï¼š" class="headerlink" title="é»˜è®¤è¿‡æœŸæ—¶é—´ï¼š"></a>é»˜è®¤è¿‡æœŸæ—¶é—´ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">BROKER_CHANNEL_EXPIRED_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">120</span> * <span class="hljs-number">1000L</span>; <span class="hljs-comment">// 2 åˆ†é’Ÿ</span><br></code></pre></td></tr></table></figure>

<p>å¦‚æœ Broker è¶…è¿‡ 2 åˆ†é’Ÿæœªæ³¨å†Œï¼Œå°±è®¤ä¸ºæ‰çº¿å¹¶æ¸…ç†è·¯ç”±æ•°æ®ã€‚</p>
<hr>
<h2 id="ğŸ—‚ï¸-å››ã€æ ¸å¿ƒå†…å­˜ç»“æ„ï¼ˆRouteInfoManagerï¼‰"><a href="#ğŸ—‚ï¸-å››ã€æ ¸å¿ƒå†…å­˜ç»“æ„ï¼ˆRouteInfoManagerï¼‰" class="headerlink" title="ğŸ—‚ï¸ å››ã€æ ¸å¿ƒå†…å­˜ç»“æ„ï¼ˆRouteInfoManagerï¼‰"></a>ğŸ—‚ï¸ å››ã€æ ¸å¿ƒå†…å­˜ç»“æ„ï¼ˆRouteInfoManagerï¼‰</h2><p>NameServer ä¿å­˜ Broker æ³¨å†Œä¿¡æ¯çš„æ•°æ®ç»“æ„æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1. topic â†’ é˜Ÿåˆ—æ•°æ®</span><br>HashMap&lt;String <span class="hljs-comment">/* topic */</span>, List&lt;QueueData&gt;&gt; topicQueueTable;<br><br><span class="hljs-comment">// 2. brokerName â†’ BrokerDataï¼ˆåŒ…æ‹¬ master/slave åœ°å€ï¼‰</span><br>HashMap&lt;String <span class="hljs-comment">/* brokerName */</span>, BrokerData&gt; brokerAddrTable;<br><br><span class="hljs-comment">// 3. clusterName â†’ brokerName åˆ—è¡¨</span><br>HashMap&lt;String <span class="hljs-comment">/* clusterName */</span>, Set&lt;String&gt;&gt; clusterAddrTable;<br><br><span class="hljs-comment">// 4. brokerAddr â†’ BrokerLiveInfoï¼ˆåŒ…æ‹¬æœ€åå¿ƒè·³æ—¶é—´ï¼‰</span><br>HashMap&lt;String <span class="hljs-comment">/* brokerAddr */</span>, BrokerLiveInfo&gt; brokerLiveTable;<br></code></pre></td></tr></table></figure>

<p>å½“è¶…æ—¶æ¸…ç†æ—¶ï¼Œæ‰€æœ‰è¿™äº›ç»“æ„éƒ½ä¼šæ›´æ–°ã€‚</p>
<hr>
<h2 id="ğŸ§ª-äº”ã€å®¢æˆ·ç«¯è·¯ç”±æŸ¥è¯¢ä¸å®¹ç¾"><a href="#ğŸ§ª-äº”ã€å®¢æˆ·ç«¯è·¯ç”±æŸ¥è¯¢ä¸å®¹ç¾" class="headerlink" title="ğŸ§ª äº”ã€å®¢æˆ·ç«¯è·¯ç”±æŸ¥è¯¢ä¸å®¹ç¾"></a>ğŸ§ª äº”ã€å®¢æˆ·ç«¯è·¯ç”±æŸ¥è¯¢ä¸å®¹ç¾</h2><ul>
<li><p><strong>Producer&#x2F;Consumer ä¼šå®šæ—¶ä» NameServer æ‹‰å–æœ€æ–°è·¯ç”±ä¿¡æ¯</strong></p>
</li>
<li><p>å¦‚æœ Broker æ‰çº¿ï¼ŒNameServer åœ¨ä¸¤åˆ†é’Ÿåä¼šæ¸…é™¤å®ƒ</p>
</li>
<li><p>ä¸‹æ¬¡å®¢æˆ·ç«¯æ‹‰è·¯ç”±æ—¶å°†ä¸å†åŒ…å«è¯¥ Brokerï¼Œè‡ªåŠ¨å®ç°å®¹ç¾è½¬ç§»</p>
</li>
</ul>
<hr>
<h2 id="âœ…-æ€»ç»“ä¸€å¥è¯ï¼š"><a href="#âœ…-æ€»ç»“ä¸€å¥è¯ï¼š" class="headerlink" title="âœ… æ€»ç»“ä¸€å¥è¯ï¼š"></a>âœ… æ€»ç»“ä¸€å¥è¯ï¼š</h2><blockquote>
<p>RocketMQ çš„ Broker é€šè¿‡æ¯ 30 ç§’ä¸€æ¬¡çš„å®šæ—¶æ³¨å†Œï¼Œç»´æŒå’Œ NameServer çš„â€œå¿ƒè·³â€ï¼›NameServer æ¯ 10 ç§’æ‰«æä¸€æ¬¡ Broker æ´»è·ƒçŠ¶æ€ï¼Œè¶…è¿‡ 2 åˆ†é’Ÿæœªæ³¨å†Œå³åˆ¤ä¸ºæ‰çº¿ï¼Œè‡ªåŠ¨æ¸…é™¤å…¶è·¯ç”±ä¿¡æ¯ã€‚</p>
</blockquote>
<p>è¿™ç§æœºåˆ¶ç®€å•ã€æ— ä¸­å¿ƒåŒ–ä¾èµ–ã€ææ˜“æ‰©å±•ï¼Œéå¸¸é€‚åˆé«˜æ€§èƒ½åœºæ™¯ã€‚</p>
<hr>
<h2 id="ğŸ“Œ-è¡¥å……ï¼šä¸»ä»-Broker-çš„æ³¨å†Œå·®å¼‚"><a href="#ğŸ“Œ-è¡¥å……ï¼šä¸»ä»-Broker-çš„æ³¨å†Œå·®å¼‚" class="headerlink" title="ğŸ“Œ è¡¥å……ï¼šä¸»ä» Broker çš„æ³¨å†Œå·®å¼‚"></a>ğŸ“Œ è¡¥å……ï¼šä¸»ä» Broker çš„æ³¨å†Œå·®å¼‚</h2><ul>
<li><p>ä¸»èŠ‚ç‚¹ï¼ˆMasterï¼‰å’Œä»èŠ‚ç‚¹ï¼ˆSlaveï¼‰éƒ½ä¼šæ³¨å†Œåˆ° NameServer</p>
</li>
<li><p>ä¸»èŠ‚ç‚¹çš„è·¯ç”±é€šå¸¸ç”¨äºå†™æ“ä½œ</p>
</li>
<li><p>å¦‚æœä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œåªæœ‰åœ¨ <strong>æ‰‹åŠ¨é€‰ä¸»</strong> æˆ–ä½¿ç”¨ <strong>ActingMaster æ¨¡å¼</strong> æ‰èƒ½æ¢å¤å†™èƒ½åŠ›ï¼ˆRocketMQ 5.xï¼‰</p>
</li>
</ul>
<h1 id="RocketMQ-Producerå‘é€æ¶ˆæ¯è¿‡ç¨‹è§£è¯»"><a href="#RocketMQ-Producerå‘é€æ¶ˆæ¯è¿‡ç¨‹è§£è¯»" class="headerlink" title="RocketMQ Producerå‘é€æ¶ˆæ¯è¿‡ç¨‹è§£è¯»"></a><strong>RocketMQ Producerå‘é€æ¶ˆæ¯è¿‡ç¨‹è§£è¯»</strong></h1><hr>
<h2 id="1-Producer-å‘é€æ¶ˆæ¯çš„å…¥å£"><a href="#1-Producer-å‘é€æ¶ˆæ¯çš„å…¥å£" class="headerlink" title="1. Producer å‘é€æ¶ˆæ¯çš„å…¥å£"></a>1. Producer å‘é€æ¶ˆæ¯çš„å…¥å£</h2><p>ç”¨æˆ·ä¸šåŠ¡ä»£ç é€šå¸¸è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(Message msg);<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•åº•å±‚ä¼šè°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">sendDefaultImpl(msg, communicationMode, sendCallback, timeout);<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="2-è·¯ç”±è·å–ï¼ˆå‘-NameServer-æ‹‰å–-Topic-è·¯ç”±ï¼‰"><a href="#2-è·¯ç”±è·å–ï¼ˆå‘-NameServer-æ‹‰å–-Topic-è·¯ç”±ï¼‰" class="headerlink" title="2. è·¯ç”±è·å–ï¼ˆå‘ NameServer æ‹‰å– Topic è·¯ç”±ï¼‰"></a>2. è·¯ç”±è·å–ï¼ˆå‘ NameServer æ‹‰å– Topic è·¯ç”±ï¼‰</h2><p>å‘é€å‰ï¼ŒProducer éœ€è¦çŸ¥é“ï¼š</p>
<ul>
<li><p>Topic å¯¹åº”çš„ Broker åˆ—è¡¨</p>
</li>
<li><p>Broker ä¸Šçš„å†™é˜Ÿåˆ—æ•°é‡</p>
</li>
</ul>
<p>RocketMQ ä½¿ç”¨ <strong><code>MQClientInstance</code></strong> ç®¡ç†å®¢æˆ·ç«¯å®ä¾‹å’Œè·¯ç”±ä¿¡æ¯ç¼“å­˜ã€‚</p>
<ul>
<li><p><code>MQClientInstance.getTopicRouteInfoFromNameServer(...)</code> è§¦å‘å‘ NameServer æ‹‰å–æœ€æ–°è·¯ç”±</p>
</li>
<li><p>è·¯ç”±ä¿¡æ¯ç¼“å­˜åœ¨ <code>TopicPublishInfo</code> å¯¹è±¡ä¸­</p>
</li>
</ul>
<hr>
<h2 id="3-é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰"><a href="#3-é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰" class="headerlink" title="3. é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰"></a>3. é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰</h2><p>Producer è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">MessageQueue</span> <span class="hljs-variable">mq</span> <span class="hljs-operator">=</span> topicPublishInfo.selectMessageQueue();<br></code></pre></td></tr></table></figure>

<p>é€‰æ‹©ç®—æ³•ï¼š</p>
<ul>
<li><p>è½®è¯¢ï¼ˆé»˜è®¤ï¼‰</p>
</li>
<li><p>æŒ‰å†™æƒé‡æˆ– Broker ç­–ç•¥</p>
</li>
<li><p>å¯è‡ªå®šä¹‰</p>
</li>
</ul>
<p><code>MessageQueue</code> åŒ…å«ï¼š</p>
<ul>
<li><p>BrokerName</p>
</li>
<li><p>é˜Ÿåˆ—IDï¼ˆé˜Ÿåˆ—åºå·ï¼‰</p>
</li>
<li><p>é˜Ÿåˆ—æƒé™ï¼ˆå†™&#x2F;è¯»ï¼‰</p>
</li>
</ul>
<hr>
<h2 id="4-å‘é€æ¶ˆæ¯ï¼ˆè°ƒç”¨ç½‘ç»œé€šä¿¡ï¼‰"><a href="#4-å‘é€æ¶ˆæ¯ï¼ˆè°ƒç”¨ç½‘ç»œé€šä¿¡ï¼‰" class="headerlink" title="4. å‘é€æ¶ˆæ¯ï¼ˆè°ƒç”¨ç½‘ç»œé€šä¿¡ï¼‰"></a>4. å‘é€æ¶ˆæ¯ï¼ˆè°ƒç”¨ç½‘ç»œé€šä¿¡ï¼‰</h2><h3 id="4-1-å‘é€æ¥å£è°ƒç”¨"><a href="#4-1-å‘é€æ¥å£è°ƒç”¨" class="headerlink" title="4.1 å‘é€æ¥å£è°ƒç”¨"></a>4.1 å‘é€æ¥å£è°ƒç”¨</h3><p>Producer è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">sendKernelImpl(msg, mq, communicationMode, sendCallback, timeout);<br></code></pre></td></tr></table></figure>

<p>æ ¹æ®é€šä¿¡æ¨¡å¼é€‰æ‹©ï¼š</p>
<ul>
<li><p>åŒæ­¥ï¼ˆSYNCï¼‰</p>
</li>
<li><p>å¼‚æ­¥ï¼ˆASYNCï¼‰</p>
</li>
<li><p>å•å‘ï¼ˆONEWAYï¼‰</p>
</li>
</ul>
<hr>
<h3 id="4-2-å‘é€è¯·æ±‚æ„é€ ï¼ˆRemotingCommandï¼‰"><a href="#4-2-å‘é€è¯·æ±‚æ„é€ ï¼ˆRemotingCommandï¼‰" class="headerlink" title="4.2 å‘é€è¯·æ±‚æ„é€ ï¼ˆRemotingCommandï¼‰"></a>4.2 å‘é€è¯·æ±‚æ„é€ ï¼ˆRemotingCommandï¼‰</h3><p>å†…éƒ¨å°è£…æˆ RocketMQ è‡ªå®šä¹‰çš„è¯·æ±‚åè®® <code>RemotingCommand</code>ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><p>è¯·æ±‚ç ï¼ˆ<code>SEND_MESSAGE</code>ï¼‰</p>
</li>
<li><p>æ¶ˆæ¯ä½“ï¼ˆç»åºåˆ—åŒ–ï¼‰</p>
</li>
<li><p>ä¸»é¢˜ã€é˜Ÿåˆ—IDã€æ ‡è®°ç­‰å…ƒæ•°æ®</p>
</li>
</ul>
<hr>
<h3 id="4-3-é€šè¿‡-Netty-å‘é€æ¶ˆæ¯"><a href="#4-3-é€šè¿‡-Netty-å‘é€æ¶ˆæ¯" class="headerlink" title="4.3 é€šè¿‡ Netty å‘é€æ¶ˆæ¯"></a>4.3 é€šè¿‡ Netty å‘é€æ¶ˆæ¯</h3><p>Producer åº•å±‚ä½¿ç”¨ <code>NettyRemotingClient</code> è¿æ¥ Brokerï¼š</p>
<ul>
<li><p>åˆ›å»º TCP è¿æ¥ï¼ˆé•¿è¿æ¥å¤ç”¨ï¼‰</p>
</li>
<li><p>å‘é€æ¶ˆæ¯è¯·æ±‚</p>
</li>
<li><p>ç­‰å¾… Broker å“åº”ï¼ˆåŒæ­¥æˆ–å¼‚æ­¥å›è°ƒï¼‰</p>
</li>
</ul>
<hr>
<h2 id="5-Broker-æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯"><a href="#5-Broker-æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯" class="headerlink" title="5. Broker æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯"></a>5. Broker æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯</h2><p>Broker æ”¶åˆ°å‘é€è¯·æ±‚åï¼š</p>
<ul>
<li><p>è¿›è¡Œæƒé™æ ¡éªŒï¼ˆTopic æ˜¯å¦å…è®¸å†™å…¥ï¼‰</p>
</li>
<li><p>æŒä¹…åŒ–æ¶ˆæ¯åˆ° CommitLog</p>
</li>
<li><p>æ›´æ–°æ¶ˆè´¹é˜Ÿåˆ—ï¼ˆConsumerQueueï¼‰</p>
</li>
<li><p>è¿”å›æ¶ˆæ¯å­˜å‚¨ç»“æœï¼ˆåŒ…æ‹¬ MsgIdã€å­˜å‚¨åç§»é‡ï¼‰</p>
</li>
</ul>
<hr>
<h2 id="6-Producer-æ¥æ”¶å“åº”"><a href="#6-Producer-æ¥æ”¶å“åº”" class="headerlink" title="6. Producer æ¥æ”¶å“åº”"></a>6. Producer æ¥æ”¶å“åº”</h2><ul>
<li><p>åŒæ­¥æ¨¡å¼ä¸‹ç­‰å¾…å“åº”ï¼Œå¾—åˆ° <code>SendResult</code> å¯¹è±¡</p>
</li>
<li><p>å¼‚æ­¥æ¨¡å¼ä¸‹é€šè¿‡å›è°ƒå‡½æ•°å¤„ç†ç»“æœ</p>
</li>
<li><p>å•å‘æ¨¡å¼ä¸ç­‰å¾…å“åº”</p>
</li>
</ul>
<hr>
<h2 id="7-å¤±è´¥é‡è¯•å’Œäº‹åŠ¡æ¶ˆæ¯"><a href="#7-å¤±è´¥é‡è¯•å’Œäº‹åŠ¡æ¶ˆæ¯" class="headerlink" title="7. å¤±è´¥é‡è¯•å’Œäº‹åŠ¡æ¶ˆæ¯"></a>7. å¤±è´¥é‡è¯•å’Œäº‹åŠ¡æ¶ˆæ¯</h2><ul>
<li><p>å¦‚æœå‘é€å¤±è´¥ï¼ŒProducer æ”¯æŒè‡ªåŠ¨é‡è¯•</p>
</li>
<li><p>äº‹åŠ¡æ¶ˆæ¯åˆ™è¿›å…¥ä¸¤é˜¶æ®µæäº¤æµç¨‹ï¼ˆè¿™é‡Œä¸ç»†è¯´ï¼‰</p>
</li>
</ul>
<hr>
<h2 id="ğŸ“-æµç¨‹æ€»ç»“å›¾"><a href="#ğŸ“-æµç¨‹æ€»ç»“å›¾" class="headerlink" title="ğŸ“ æµç¨‹æ€»ç»“å›¾"></a>ğŸ“ æµç¨‹æ€»ç»“å›¾</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs text">[ä¸šåŠ¡è°ƒç”¨ producer.send()]<br>           â†“<br>  è·å– Topic è·¯ç”±ä¿¡æ¯ï¼ˆNameServerï¼‰<br>           â†“<br>   é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessageQueueï¼‰<br>           â†“<br>æ„é€ å‘é€è¯·æ±‚ï¼ˆRemotingCommandï¼‰<br>           â†“<br>      Netty å‘é€æ¶ˆæ¯è¯·æ±‚<br>           â†“<br>        Broker å¤„ç†æ¶ˆæ¯<br>           â†“<br>     è¿”å›å‘é€ç»“æœå“åº”<br>           â†“<br>      Producer å¤„ç†å“åº”<br>           â†“<br>       è¿”å›ç»™ä¸šåŠ¡å±‚ SendResult<br></code></pre></td></tr></table></figure>
<h1 id="RocketMQ-Consumeræ‹‰å–æ¶ˆæ¯è¿‡ç¨‹è§£è¯»"><a href="#RocketMQ-Consumeræ‹‰å–æ¶ˆæ¯è¿‡ç¨‹è§£è¯»" class="headerlink" title="RocketMQ Consumeræ‹‰å–æ¶ˆæ¯è¿‡ç¨‹è§£è¯»"></a><strong>RocketMQ Consumeræ‹‰å–æ¶ˆæ¯è¿‡ç¨‹è§£è¯»</strong></h1><hr>
<h2 id="1-Consumer-å¯åŠ¨è®¢é˜…æµç¨‹"><a href="#1-Consumer-å¯åŠ¨è®¢é˜…æµç¨‹" class="headerlink" title="1. Consumer å¯åŠ¨è®¢é˜…æµç¨‹"></a>1. Consumer å¯åŠ¨è®¢é˜…æµç¨‹</h2><p>ç”¨æˆ·è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">consumer.subscribe(topic, subExpression);<br></code></pre></td></tr></table></figure>

<ul>
<li><p>è®¢é˜…ä¸»é¢˜å’Œè¿‡æ»¤è¡¨è¾¾å¼</p>
</li>
<li><p>Consumer å‘ <code>MQClientInstance</code> æ³¨å†Œè®¢é˜…å…³ç³»</p>
</li>
<li><p>å®¢æˆ·ç«¯å¼€å§‹ç»´æŠ¤å¯¹åº” Topic çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessageQueueï¼‰åˆ—è¡¨</p>
</li>
</ul>
<hr>
<h2 id="2-æ‹‰å–æ¶ˆæ¯è§¦å‘ç‚¹"><a href="#2-æ‹‰å–æ¶ˆæ¯è§¦å‘ç‚¹" class="headerlink" title="2. æ‹‰å–æ¶ˆæ¯è§¦å‘ç‚¹"></a>2. æ‹‰å–æ¶ˆæ¯è§¦å‘ç‚¹</h2><p>RocketMQ ä¸»è¦æœ‰ä¸¤ç§æ¶ˆè´¹æ¨¡å¼ï¼š</p>
<table>
<thead>
<tr>
<th>æ¨¡å¼</th>
<th>æ¶ˆè´¹è§¦å‘æ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Push</strong></td>
<td>Consumer é•¿è½®è¯¢ Brokerï¼Œæ”¶åˆ°æ¶ˆæ¯åå›è°ƒç›‘å¬å™¨</td>
</tr>
<tr>
<td><strong>Pull</strong></td>
<td>ä¸šåŠ¡ä¸»åŠ¨è°ƒç”¨ <code>pull</code> æ¥å£æ‹‰æ¶ˆæ¯</td>
</tr>
</tbody></table>
<p><strong>é»˜è®¤æ˜¯ Push æ¨¡å¼</strong>ï¼Œæ¶ˆè´¹è€…å®¢æˆ·ç«¯å†…éƒ¨å®ç°äº†å®šæ—¶æˆ–å¼‚æ­¥æ‹‰å–æ¶ˆæ¯ã€‚</p>
<hr>
<h2 id="3-è·å–-Topic-è·¯ç”±ä¿¡æ¯"><a href="#3-è·å–-Topic-è·¯ç”±ä¿¡æ¯" class="headerlink" title="3. è·å– Topic è·¯ç”±ä¿¡æ¯"></a>3. è·å– Topic è·¯ç”±ä¿¡æ¯</h2><p>ç±»ä¼¼ Producerï¼ŒConsumer ä¹Ÿéœ€è¦ä» NameServer è·å– Topic è·¯ç”±ä¿¡æ¯ï¼Œç¡®å®šå¯ç”¨ Broker åˆ—è¡¨å’Œé˜Ÿåˆ—åˆ†å¸ƒã€‚</p>
<ul>
<li><p>ç¼“å­˜åœ¨ <code>TopicSubscribeInfo</code></p>
</li>
<li><p>åŒ…å« MessageQueue åˆ—è¡¨å’Œè¯»å†™æƒé™ä¿¡æ¯</p>
</li>
</ul>
<hr>
<h2 id="4-æ‹‰å–æ¶ˆæ¯è¯·æ±‚æ„é€ "><a href="#4-æ‹‰å–æ¶ˆæ¯è¯·æ±‚æ„é€ " class="headerlink" title="4. æ‹‰å–æ¶ˆæ¯è¯·æ±‚æ„é€ "></a>4. æ‹‰å–æ¶ˆæ¯è¯·æ±‚æ„é€ </h2><p>å®¢æˆ·ç«¯æ ¹æ®è®¢é˜…çš„é˜Ÿåˆ—å’Œæ¶ˆè´¹è¿›åº¦ï¼ˆoffsetï¼‰æ„é€ æ‹‰å–è¯·æ±‚ï¼ŒåŒ…å«ï¼š</p>
<ul>
<li><p>Topic åç§°</p>
</li>
<li><p>é˜Ÿåˆ— IDï¼ˆMessageQueueï¼‰</p>
</li>
<li><p>æ¶ˆè´¹è¿›åº¦ï¼ˆoffsetï¼‰</p>
</li>
<li><p>æ¶ˆæ¯æ•°é‡ï¼ˆbatch sizeï¼‰</p>
</li>
<li><p>è¿‡æ»¤è¡¨è¾¾å¼ï¼ˆå¯é€‰ï¼‰</p>
</li>
</ul>
<hr>
<h2 id="5-å‘é€æ‹‰å–è¯·æ±‚ï¼ˆNetty-é€šä¿¡ï¼‰"><a href="#5-å‘é€æ‹‰å–è¯·æ±‚ï¼ˆNetty-é€šä¿¡ï¼‰" class="headerlink" title="5. å‘é€æ‹‰å–è¯·æ±‚ï¼ˆNetty é€šä¿¡ï¼‰"></a>5. å‘é€æ‹‰å–è¯·æ±‚ï¼ˆNetty é€šä¿¡ï¼‰</h2><p>Consumer åº•å±‚ä½¿ç”¨ <code>NettyRemotingClient</code> è¿æ¥ Brokerï¼Œå‘é€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">RequestCode.PULL_MESSAGE<br></code></pre></td></tr></table></figure>

<p>è¯·æ±‚åŒ…å«æ‹‰å–å‚æ•°ã€‚</p>
<hr>
<h2 id="6-Broker-å¤„ç†æ‹‰å–è¯·æ±‚"><a href="#6-Broker-å¤„ç†æ‹‰å–è¯·æ±‚" class="headerlink" title="6. Broker å¤„ç†æ‹‰å–è¯·æ±‚"></a>6. Broker å¤„ç†æ‹‰å–è¯·æ±‚</h2><p>Broker æ¥æ”¶åˆ°æ‹‰å–è¯·æ±‚ï¼š</p>
<ul>
<li><p>æ ¹æ® Topic + Queue + Offset æŸ¥è¯¢æ¶ˆæ¯å­˜å‚¨ï¼ˆCommitLogï¼‰</p>
</li>
<li><p>è¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰è¿‡æ»¤è¡¨è¾¾å¼ï¼‰</p>
</li>
<li><p>å°†æ¶ˆæ¯æ‰“åŒ…è¿”å›ç»™ Consumer</p>
</li>
</ul>
<hr>
<h2 id="7-Consumer-æ¥æ”¶æ¶ˆæ¯"><a href="#7-Consumer-æ¥æ”¶æ¶ˆæ¯" class="headerlink" title="7. Consumer æ¥æ”¶æ¶ˆæ¯"></a>7. Consumer æ¥æ”¶æ¶ˆæ¯</h2><ul>
<li><p>Consumer æ”¶åˆ°æ¶ˆæ¯æ•°æ®åŒ…</p>
</li>
<li><p>è§£ææˆæ¶ˆæ¯å¯¹è±¡é›†åˆï¼ˆMessageExtListï¼‰</p>
</li>
<li><p>è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„æ¶ˆæ¯ç›‘å¬å™¨ï¼ˆMessageListenerï¼‰å¤„ç†æ¶ˆæ¯</p>
</li>
</ul>
<hr>
<h2 id="8-æ¶ˆè´¹è¿›åº¦æäº¤ï¼ˆoffset-ç®¡ç†ï¼‰"><a href="#8-æ¶ˆè´¹è¿›åº¦æäº¤ï¼ˆoffset-ç®¡ç†ï¼‰" class="headerlink" title="8. æ¶ˆè´¹è¿›åº¦æäº¤ï¼ˆoffset ç®¡ç†ï¼‰"></a>8. æ¶ˆè´¹è¿›åº¦æäº¤ï¼ˆoffset ç®¡ç†ï¼‰</h2><p>æ¶ˆè´¹æˆåŠŸåï¼ŒConsumer ä¼šæ›´æ–°æ¶ˆè´¹è¿›åº¦ï¼š</p>
<ul>
<li><p><strong>è‡ªåŠ¨æäº¤</strong>ï¼ˆé»˜è®¤ï¼‰</p>
</li>
<li><p>æˆ–è€…ä¸šåŠ¡ä»£ç ä¸»åŠ¨è°ƒç”¨ <code>commit()</code> æ›´æ–°</p>
</li>
</ul>
<p>æ¶ˆè´¹è¿›åº¦å¯å­˜å‚¨åœ¨ï¼š</p>
<ul>
<li><p>Brokerï¼ˆåŸºäºæ¶ˆè´¹ç»„ç»´åº¦ï¼‰</p>
</li>
<li><p>æœ¬åœ°æ–‡ä»¶æˆ–å…¶ä»–æŒä¹…åŒ–ä»‹è´¨ï¼ˆé«˜çº§é€‰é¡¹ï¼‰</p>
</li>
</ul>
<hr>
<h2 id="9-æ¶ˆæ¯é‡è¯•å’Œå¤±è´¥å¤„ç†"><a href="#9-æ¶ˆæ¯é‡è¯•å’Œå¤±è´¥å¤„ç†" class="headerlink" title="9. æ¶ˆæ¯é‡è¯•å’Œå¤±è´¥å¤„ç†"></a>9. æ¶ˆæ¯é‡è¯•å’Œå¤±è´¥å¤„ç†</h2><ul>
<li><p>å¦‚æœæ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯ä¼šè¢«é‡æ–°æŠ•é€’ï¼ˆé‡è¯•æœºåˆ¶ï¼‰</p>
</li>
<li><p>è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œæ¶ˆæ¯å¯èƒ½è¢«è½¬å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰</p>
</li>
</ul>
<hr>
<h2 id="ğŸ“-æ‹‰å–æ¶ˆæ¯æµç¨‹ç®€åŒ–å›¾"><a href="#ğŸ“-æ‹‰å–æ¶ˆæ¯æµç¨‹ç®€åŒ–å›¾" class="headerlink" title="ğŸ“ æ‹‰å–æ¶ˆæ¯æµç¨‹ç®€åŒ–å›¾"></a>ğŸ“ æ‹‰å–æ¶ˆæ¯æµç¨‹ç®€åŒ–å›¾</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs text">Consumerå¯åŠ¨è®¢é˜…<br>       â†“<br>è·å–Topicè·¯ç”±ä¿¡æ¯<br>       â†“<br>æ ¹æ®offsetæ„é€ æ‹‰å–è¯·æ±‚<br>       â†“<br>  Nettyå‘é€PULL_MESSAGEè¯·æ±‚<br>       â†“<br> BrokeræŸ¥è¯¢æ¶ˆæ¯å¹¶è¿”å›<br>       â†“<br> Consumeræ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯<br>       â†“<br>æ›´æ–°æ¶ˆè´¹è¿›åº¦offset<br>       â†“<br>æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸ / é‡è¯•æˆ–DLQ<br></code></pre></td></tr></table></figure>
<h1 id="RocketMQ-æ¶ˆæ¯æŒä¹…åŒ–æœºåˆ¶ä»‹ç»"><a href="#RocketMQ-æ¶ˆæ¯æŒä¹…åŒ–æœºåˆ¶ä»‹ç»" class="headerlink" title="RocketMQ æ¶ˆæ¯æŒä¹…åŒ–æœºåˆ¶ä»‹ç»"></a><strong>RocketMQ æ¶ˆæ¯æŒä¹…åŒ–æœºåˆ¶ä»‹ç»</strong></h1><hr>
<h2 id="1-RocketMQ-æŒä¹…åŒ–æ¦‚è¿°"><a href="#1-RocketMQ-æŒä¹…åŒ–æ¦‚è¿°" class="headerlink" title="1. RocketMQ æŒä¹…åŒ–æ¦‚è¿°"></a>1. RocketMQ æŒä¹…åŒ–æ¦‚è¿°</h2><p>RocketMQ çš„æ¶ˆæ¯æŒä¹…åŒ–è®¾è®¡æ³¨é‡ <strong>é«˜æ€§èƒ½ä¸æ•°æ®å®‰å…¨</strong>ï¼Œå…¶æ ¸å¿ƒæ˜¯åŸºäº <strong>é¡ºåºå†™å…¥</strong> å’Œ <strong>æ–‡ä»¶æ˜ å°„å†…å­˜</strong>ï¼Œé…åˆå¤šç§æœºåˆ¶ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ã€‚</p>
<hr>
<h2 id="2-æ ¸å¿ƒå­˜å‚¨ç»„ä»¶"><a href="#2-æ ¸å¿ƒå­˜å‚¨ç»„ä»¶" class="headerlink" title="2. æ ¸å¿ƒå­˜å‚¨ç»„ä»¶"></a>2. æ ¸å¿ƒå­˜å‚¨ç»„ä»¶</h2><table>
<thead>
<tr>
<th>ç»„ä»¶</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><strong>CommitLog</strong></td>
<td>æ¶ˆæ¯å­˜å‚¨ä¸»æ–‡ä»¶ï¼Œé¡ºåºè¿½åŠ å†™å…¥æ¶ˆæ¯æ•°æ®</td>
</tr>
<tr>
<td><strong>ConsumeQueue</strong></td>
<td>æ¶ˆæ¯æ¶ˆè´¹ç´¢å¼•ï¼ŒæŒ‡å‘ CommitLog ä¸­æ¶ˆæ¯ä½ç½®</td>
</tr>
<tr>
<td><strong>IndexFile</strong></td>
<td>æ¶ˆæ¯ç´¢å¼•æ–‡ä»¶ï¼Œæ”¯æŒæŒ‰ key æŸ¥è¯¢æ¶ˆæ¯</td>
</tr>
</tbody></table>
<hr>
<h2 id="3-CommitLog-è¯¦è§£"><a href="#3-CommitLog-è¯¦è§£" class="headerlink" title="3. CommitLog è¯¦è§£"></a>3. CommitLog è¯¦è§£</h2><ul>
<li><p><strong>é¡ºåºè¿½åŠ å†™å…¥</strong>ï¼šæ¶ˆæ¯æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªå¤§æ–‡ä»¶ï¼ŒæŒ‰é¡ºåºå†™ï¼Œé¿å…éšæœºç£ç›˜ I&#x2F;O</p>
</li>
<li><p>é»˜è®¤æ–‡ä»¶å¤§å°ï¼š1GB ä¸€ä¸ªæ–‡ä»¶ï¼ˆæ–‡ä»¶åä»¥åç§»é‡å‘½åï¼‰</p>
</li>
<li><p><strong>æ¶ˆæ¯ç»“æ„</strong>ï¼šæ¶ˆæ¯å¤´ + æ¶ˆæ¯ä½“ + æ ¡éªŒç  + å…¶ä»–å…ƒä¿¡æ¯</p>
</li>
<li><p><strong>å†…å­˜æ˜ å°„æ–‡ä»¶ï¼ˆMappedFileï¼‰</strong>ï¼šä½¿ç”¨ <code>MappedByteBuffer</code>ï¼Œå°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ï¼Œæé«˜è¯»å†™æ•ˆç‡</p>
</li>
</ul>
<hr>
<h2 id="4-æ¶ˆæ¯å†™å…¥æµç¨‹"><a href="#4-æ¶ˆæ¯å†™å…¥æµç¨‹" class="headerlink" title="4. æ¶ˆæ¯å†™å…¥æµç¨‹"></a>4. æ¶ˆæ¯å†™å…¥æµç¨‹</h2><ol>
<li><p><strong>æ¶ˆæ¯æ‰“åŒ…</strong>ï¼šProducer å‘é€çš„æ¶ˆæ¯ç»è¿‡åºåˆ—åŒ–å½¢æˆæ¶ˆæ¯ä½“</p>
</li>
<li><p><strong>å¼‚æ­¥åˆ·ç›˜ &#x2F; åŒæ­¥åˆ·ç›˜</strong>ï¼š</p>
<ul>
<li><p><strong>å¼‚æ­¥åˆ·ç›˜ï¼ˆé»˜è®¤ï¼‰</strong>ï¼šæ¶ˆæ¯å…ˆå†™å…¥æ“ä½œç³»ç»Ÿé¡µç¼“å­˜ï¼Œåå°çº¿ç¨‹å®šæ—¶åˆ·ç›˜åˆ°ç£ç›˜ï¼Œæé«˜åå</p>
</li>
<li><p><strong>åŒæ­¥åˆ·ç›˜</strong>ï¼šç­‰å¾…æ¶ˆæ¯å†™å…¥ç£ç›˜ç¡®è®¤ï¼Œç¡®ä¿æ¶ˆæ¯å®‰å…¨ï¼Œæ€§èƒ½è¾ƒä½</p>
</li>
</ul>
</li>
<li><p><strong>è¿½åŠ åˆ° CommitLog</strong>ï¼š</p>
<ul>
<li>é€šè¿‡ <code>MappedFileQueue.appendMessage()</code> é¡ºåºå†™å…¥</li>
</ul>
</li>
<li><p><strong>è¿”å›æ¶ˆæ¯å­˜å‚¨ç»“æœ</strong>ï¼ŒåŒ…æ‹¬ç‰©ç†åç§»é‡</p>
</li>
</ol>
<hr>
<h2 id="5-ConsumeQueue-ç´¢å¼•æœºåˆ¶"><a href="#5-ConsumeQueue-ç´¢å¼•æœºåˆ¶" class="headerlink" title="5. ConsumeQueue ç´¢å¼•æœºåˆ¶"></a>5. ConsumeQueue ç´¢å¼•æœºåˆ¶</h2><ul>
<li><p>æ¯ä¸ª Topic-Queue å¯¹åº”ä¸€ä¸ª ConsumeQueue æ–‡ä»¶ï¼Œè®°å½•æ¶ˆæ¯åœ¨ CommitLog çš„ç‰©ç†åç§»é‡</p>
</li>
<li><p>ConsumeQueue ä»¥å›ºå®šé•¿åº¦çš„æ¡ç›®å­˜å‚¨ï¼Œä¾¿äºå¿«é€Ÿå®šä½æ¶ˆæ¯</p>
</li>
<li><p>Consumer é€šè¿‡ ConsumeQueue è¯»å–æ¶ˆæ¯åç§»ï¼Œå¿«é€Ÿä» CommitLog æ‹‰å–æ¶ˆæ¯</p>
</li>
</ul>
<hr>
<h2 id="6-æ¶ˆæ¯åˆ·ç›˜ç­–ç•¥"><a href="#6-æ¶ˆæ¯åˆ·ç›˜ç­–ç•¥" class="headerlink" title="6. æ¶ˆæ¯åˆ·ç›˜ç­–ç•¥"></a>6. æ¶ˆæ¯åˆ·ç›˜ç­–ç•¥</h2><table>
<thead>
<tr>
<th>æ¨¡å¼</th>
<th>è¯´æ˜</th>
<th>ä¼˜ç¼ºç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td><strong>å¼‚æ­¥åˆ·ç›˜</strong></td>
<td>å†™å…¥æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œå®šæ—¶åˆ·ç›˜åˆ°ç£ç›˜</td>
<td>é«˜ååï¼Œå¯èƒ½ä¸¢å°‘é‡æ•°æ®</td>
</tr>
<tr>
<td><strong>åŒæ­¥åˆ·ç›˜</strong></td>
<td>ç­‰å¾…åˆ·ç›˜ç¡®è®¤åè¿”å›</td>
<td>é«˜å¯é ï¼Œååä½</td>
</tr>
</tbody></table>
<p>åˆ·ç›˜ç­–ç•¥å¯é…ç½®ï¼š</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">flushDiskType</span> = <span class="hljs-string">ASYNC_FLUSH   # æˆ– SYNC_FLUSH</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="7-é«˜å¯ç”¨å¤åˆ¶ï¼ˆBroker-ä¸»ä»å¤åˆ¶ï¼‰"><a href="#7-é«˜å¯ç”¨å¤åˆ¶ï¼ˆBroker-ä¸»ä»å¤åˆ¶ï¼‰" class="headerlink" title="7. é«˜å¯ç”¨å¤åˆ¶ï¼ˆBroker ä¸»ä»å¤åˆ¶ï¼‰"></a>7. é«˜å¯ç”¨å¤åˆ¶ï¼ˆBroker ä¸»ä»å¤åˆ¶ï¼‰</h2><ul>
<li><p><strong>Master + Slave æ¶æ„</strong></p>
</li>
<li><p>Slave åŒæ­¥ Master çš„ CommitLog æ•°æ®</p>
</li>
<li><p>æ”¯æŒåŒæ­¥å¤åˆ¶å’Œå¼‚æ­¥å¤åˆ¶ä¸¤ç§æ¨¡å¼</p>
</li>
<li><p>æé«˜æ•°æ®å®‰å…¨æ€§å’Œå®¹ç¾èƒ½åŠ›</p>
</li>
</ul>
<hr>
<h2 id="8-æ¸…ç†ç­–ç•¥"><a href="#8-æ¸…ç†ç­–ç•¥" class="headerlink" title="8. æ¸…ç†ç­–ç•¥"></a>8. æ¸…ç†ç­–ç•¥</h2><ul>
<li><p>æ ¹æ®ç£ç›˜ä½¿ç”¨ç‡å’Œæ—¶é—´é˜ˆå€¼è‡ªåŠ¨åˆ é™¤è¿‡æœŸ CommitLog æ–‡ä»¶</p>
</li>
<li><p>é…åˆæ¶ˆæ¯æ¶ˆè´¹çŠ¶æ€ï¼Œç¡®ä¿ä¸åˆ é™¤æœªæ¶ˆè´¹æ¶ˆæ¯</p>
</li>
</ul>
<hr>
<h2 id="ğŸ“-å­˜å‚¨ç»“æ„ç®€å›¾"><a href="#ğŸ“-å­˜å‚¨ç»“æ„ç®€å›¾" class="headerlink" title="ğŸ“ å­˜å‚¨ç»“æ„ç®€å›¾"></a>ğŸ“ å­˜å‚¨ç»“æ„ç®€å›¾</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs text">+---------------------------+<br>|         CommitLog         |  é¡ºåºå­˜å‚¨æ¶ˆæ¯æ•°æ®ï¼ˆæ¶ˆæ¯ä½“ã€å…ƒæ•°æ®ï¼‰<br>+---------------------------+<br>           â†‘<br>           | ç‰©ç†åç§»<br>+---------------------------+<br>|       ConsumeQueue        |  æ¶ˆæ¯æ¶ˆè´¹ç´¢å¼•ï¼Œå¿«é€Ÿå®šä½æ¶ˆæ¯åç§»<br>+---------------------------+<br>           â†‘<br>           |<br>+---------------------------+<br>|        IndexFile          |  æ ¹æ® Key å¿«é€ŸæŸ¥æ‰¾æ¶ˆæ¯<br>+---------------------------+<br></code></pre></td></tr></table></figure>
<h1 id="RocketMQ-CommitLogå†™å…¥è¿‡ç¨‹è§£è¯»"><a href="#RocketMQ-CommitLogå†™å…¥è¿‡ç¨‹è§£è¯»" class="headerlink" title="RocketMQ CommitLogå†™å…¥è¿‡ç¨‹è§£è¯»"></a><strong>RocketMQ CommitLogå†™å…¥è¿‡ç¨‹è§£è¯»</strong></h1><hr>
<h2 id="1-å†™å…¥å…¥å£"><a href="#1-å†™å…¥å…¥å£" class="headerlink" title="1. å†™å…¥å…¥å£"></a>1. å†™å…¥å…¥å£</h2><p>å½“ Broker æ”¶åˆ°å‘é€è¯·æ±‚æ—¶ï¼Œæœ€ç»ˆè°ƒç”¨çš„å†™å…¥æ¥å£æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> AppendMessageResult <span class="hljs-title function_">appendMessage</span><span class="hljs-params">(MessageExtBrokerInner msg)</span><br></code></pre></td></tr></table></figure>

<p>æ­¤æ–¹æ³•ä½äº <code>CommitLog</code> ç±»ä¸­ï¼Œè´Ÿè´£å°†æ¶ˆæ¯è¿½åŠ å†™å…¥åˆ° CommitLog æ–‡ä»¶ã€‚</p>
<hr>
<h2 id="2-æ–‡ä»¶é€‰æ‹©"><a href="#2-æ–‡ä»¶é€‰æ‹©" class="headerlink" title="2. æ–‡ä»¶é€‰æ‹©"></a>2. æ–‡ä»¶é€‰æ‹©</h2><ul>
<li><p>RocketMQ å°† CommitLog åˆ†æˆå¤šä¸ªå›ºå®šå¤§å°æ–‡ä»¶ï¼ˆé»˜è®¤ 1GBï¼‰</p>
</li>
<li><p>æ ¹æ®å½“å‰å†™æŒ‡é’ˆï¼ˆ<code>wrotePosition</code>ï¼‰ï¼Œæ‰¾åˆ°å½“å‰å¯å†™çš„ <code>MappedFile</code></p>
</li>
<li><p>å¦‚æœå½“å‰æ–‡ä»¶ç©ºé—´ä¸è¶³ï¼Œä¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ–‡ä»¶</p>
</li>
</ul>
<hr>
<h2 id="3-æ¶ˆæ¯åºåˆ—åŒ–"><a href="#3-æ¶ˆæ¯åºåˆ—åŒ–" class="headerlink" title="3. æ¶ˆæ¯åºåˆ—åŒ–"></a>3. æ¶ˆæ¯åºåˆ—åŒ–</h2><p>æ¶ˆæ¯ä¼šè¢«åºåˆ—åŒ–æˆå­—èŠ‚æ•°ç»„ï¼Œç»“æ„åŒ…å«ï¼š</p>
<table>
<thead>
<tr>
<th>éƒ¨åˆ†</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>æ€»é•¿åº¦</td>
<td>æ¶ˆæ¯æ€»å­—èŠ‚æ•°</td>
</tr>
<tr>
<td>é­”æ•°</td>
<td>ç”¨äºæ ¡éªŒæ•°æ®æ­£ç¡®æ€§</td>
</tr>
<tr>
<td>ç‰©ç†åç§»é‡</td>
<td>å½“å‰æ¶ˆæ¯åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡</td>
</tr>
<tr>
<td>æ¶ˆæ¯ä½“</td>
<td>ä¸»é¢˜ã€æ¶ˆæ¯ä½“ã€å±æ€§ç­‰å†…å®¹</td>
</tr>
</tbody></table>
<hr>
<h2 id="4-é¡ºåºå†™å…¥ï¼ˆMappedFileï¼‰"><a href="#4-é¡ºåºå†™å…¥ï¼ˆMappedFileï¼‰" class="headerlink" title="4. é¡ºåºå†™å…¥ï¼ˆMappedFileï¼‰"></a>4. é¡ºåºå†™å…¥ï¼ˆMappedFileï¼‰</h2><p>RocketMQ ä½¿ç”¨äº† <strong>å†…å­˜æ˜ å°„æ–‡ä»¶</strong> (<code>MappedByteBuffer</code>)ï¼Œå†™å…¥æ—¶ç›´æ¥æ“ä½œæ˜ å°„åˆ°å†…å­˜çš„å­—èŠ‚ç¼“å†²åŒºï¼Œå†™æ“ä½œæ˜¯é¡ºåºè¿½åŠ ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">mappedByteBuffer.put(messageBytes);<br></code></pre></td></tr></table></figure>

<p>å†™æ“ä½œåœ¨å†…å­˜å®Œæˆï¼Œåº•å±‚æ“ä½œç³»ç»Ÿè´Ÿè´£å¼‚æ­¥åˆ·æ–°åˆ°ç£ç›˜ã€‚</p>
<hr>
<h2 id="5-è¿½åŠ å†™å…¥ç»“æœ"><a href="#5-è¿½åŠ å†™å…¥ç»“æœ" class="headerlink" title="5. è¿½åŠ å†™å…¥ç»“æœ"></a>5. è¿½åŠ å†™å…¥ç»“æœ</h2><p>å†™å…¥æˆåŠŸåï¼Œ<code>appendMessage()</code> è¿”å› <code>AppendMessageResult</code>ï¼ŒåŒ…å«ï¼š</p>
<ul>
<li><p>å†™å…¥çš„ç‰©ç†åç§»é‡ï¼ˆCommitLog æ–‡ä»¶ä¸­çš„åç§»ï¼‰</p>
</li>
<li><p>æ¶ˆæ¯IDï¼ˆé€šå¸¸æ˜¯åç§»é‡å’Œä¸»æœºä¿¡æ¯ç»„åˆï¼‰</p>
</li>
<li><p>çŠ¶æ€ç ï¼ˆæˆåŠŸæˆ–å¤±è´¥åŸå› ï¼‰</p>
</li>
</ul>
<hr>
<h2 id="6-åˆ·ç›˜æœºåˆ¶ï¼ˆFlushï¼‰"><a href="#6-åˆ·ç›˜æœºåˆ¶ï¼ˆFlushï¼‰" class="headerlink" title="6. åˆ·ç›˜æœºåˆ¶ï¼ˆFlushï¼‰"></a>6. åˆ·ç›˜æœºåˆ¶ï¼ˆFlushï¼‰</h2><p>æ¶ˆæ¯å†™å…¥ CommitLog åªæ˜¯å†™å…¥å†…å­˜æ˜ å°„ç¼“å­˜ï¼Œåˆ·ç›˜åˆ†ä¸ºä¸¤ç§ï¼š</p>
<table>
<thead>
<tr>
<th>åˆ·ç›˜ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>å¼‚æ­¥åˆ·ç›˜</td>
<td>åå°åˆ·ç›˜çº¿ç¨‹å®šæ—¶å°†æ•°æ®å†™å…¥ç£ç›˜</td>
</tr>
<tr>
<td>åŒæ­¥åˆ·ç›˜</td>
<td>ç­‰å¾…åˆ·ç›˜æ“ä½œå®Œæˆï¼Œç¡®ä¿æ•°æ®è½ç›˜</td>
</tr>
</tbody></table>
<p>åˆ·ç›˜åŠ¨ä½œç”± <code>flush()</code> æ–¹æ³•è§¦å‘ï¼Œåˆ·ç›˜å®Œæˆåæ‰èƒ½ç¡®è®¤æ¶ˆæ¯æŒä¹…åŒ–æˆåŠŸã€‚</p>
<hr>
<h2 id="7-æ¶ˆæ¯ç´¢å¼•æ„å»º"><a href="#7-æ¶ˆæ¯ç´¢å¼•æ„å»º" class="headerlink" title="7. æ¶ˆæ¯ç´¢å¼•æ„å»º"></a>7. æ¶ˆæ¯ç´¢å¼•æ„å»º</h2><p>å†™å®Œ CommitLog åï¼ŒBroker ä¼šæ›´æ–°ï¼š</p>
<ul>
<li><p><strong>ConsumeQueue</strong>ï¼ˆæ¶ˆè´¹é˜Ÿåˆ—ç´¢å¼•ï¼‰</p>
</li>
<li><p><strong>IndexFile</strong>ï¼ˆæ¶ˆæ¯é”®ç´¢å¼•ï¼‰</p>
</li>
</ul>
<p>ä¾¿äºå¿«é€ŸæŸ¥æ‰¾å’Œæ¶ˆè´¹ã€‚</p>
<hr>
<h2 id="ğŸ“-CommitLog-å†™å…¥æµç¨‹ç¤ºæ„å›¾"><a href="#ğŸ“-CommitLog-å†™å…¥æµç¨‹ç¤ºæ„å›¾" class="headerlink" title="ğŸ“ CommitLog å†™å…¥æµç¨‹ç¤ºæ„å›¾"></a>ğŸ“ CommitLog å†™å…¥æµç¨‹ç¤ºæ„å›¾</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs text">[Brokeræ¥æ”¶æ¶ˆæ¯]<br>        â†“<br>[è°ƒç”¨ CommitLog.appendMessage()]<br>        â†“<br>[é€‰æ‹©å½“å‰ MappedFile]<br>        â†“<br>[åºåˆ—åŒ–æ¶ˆæ¯æˆå­—èŠ‚]<br>        â†“<br>[é¡ºåºå†™å…¥ MappedByteBuffer]<br>        â†“<br>[è¿”å›å†™å…¥ç»“æœ AppendMessageResult]<br>        â†“<br>[åˆ·ç›˜ï¼ˆå¼‚æ­¥æˆ–åŒæ­¥ï¼‰]<br>        â†“<br>[æ›´æ–° ConsumeQueue å’Œç´¢å¼•æ–‡ä»¶]<br></code></pre></td></tr></table></figure>
<h1 id="RocketMQ-ç´¢å¼•æ–‡ä»¶ç®¡ç†è¿‡ç¨‹è§£è¯»"><a href="#RocketMQ-ç´¢å¼•æ–‡ä»¶ç®¡ç†è¿‡ç¨‹è§£è¯»" class="headerlink" title="RocketMQ ç´¢å¼•æ–‡ä»¶ç®¡ç†è¿‡ç¨‹è§£è¯»"></a><strong>RocketMQ ç´¢å¼•æ–‡ä»¶ç®¡ç†è¿‡ç¨‹è§£è¯»</strong></h1><hr>
<h2 id="ğŸ”-ä»€ä¹ˆæ˜¯-IndexFileï¼Ÿ"><a href="#ğŸ”-ä»€ä¹ˆæ˜¯-IndexFileï¼Ÿ" class="headerlink" title="ğŸ” ä»€ä¹ˆæ˜¯ IndexFileï¼Ÿ"></a>ğŸ” ä»€ä¹ˆæ˜¯ IndexFileï¼Ÿ</h2><p><code>IndexFile</code> æ˜¯ RocketMQ çš„æ¶ˆæ¯ç´¢å¼•æ–‡ä»¶ï¼Œé»˜è®¤ç”¨äº <strong>æŒ‰ Keyï¼ˆå³ Message Key æˆ– Unique Keyï¼‰å¿«é€Ÿå®šä½æ¶ˆæ¯åœ¨ CommitLog ä¸­çš„ç‰©ç†åç§»é‡</strong>ã€‚</p>
<ul>
<li><p>æ¯ä¸ª <code>IndexFile</code> æ–‡ä»¶é»˜è®¤å¯ä»¥è®°å½•çº¦ <strong>2000 ä¸‡æ¡ç´¢å¼•</strong></p>
</li>
<li><p>æ¯å¤©ä¼šç”Ÿæˆå¤šä¸ªæ–‡ä»¶ï¼Œç±»ä¼¼æ—¶é—´çª—å£æ»šåŠ¨æ—¥å¿—</p>
</li>
<li><p><strong>ä¸æ˜¯å¿…é¡»ç»„ä»¶</strong>ï¼Œåªåœ¨å¼€å¯äº† key ç´¢å¼•çš„æ¶ˆæ¯ä½¿ç”¨ï¼ˆ<code>msg.setKeys(...)</code>ï¼‰</p>
</li>
</ul>
<hr>
<h2 id="ğŸ“-ç´¢å¼•æ–‡ä»¶ç»“æ„"><a href="#ğŸ“-ç´¢å¼•æ–‡ä»¶ç»“æ„" class="headerlink" title="ğŸ“ ç´¢å¼•æ–‡ä»¶ç»“æ„"></a>ğŸ“ ç´¢å¼•æ–‡ä»¶ç»“æ„</h2><p>ä¸€ä¸ª IndexFile åŒ…å« 3 ä¸ªéƒ¨åˆ†ï¼š</p>
<table>
<thead>
<tr>
<th>åŒºåŸŸåç§°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>Index Header</td>
<td>æ–‡ä»¶å…ƒä¿¡æ¯ï¼šå¼€å§‹&#x2F;ç»“æŸæ—¶é—´æˆ³ã€åç§»ç­‰</td>
</tr>
<tr>
<td>Hash Slot åŒºåŸŸ</td>
<td>500ä¸‡ä¸ª Slotï¼Œæ¯ä¸ª4å­—èŠ‚ï¼ˆintï¼‰ï¼Œä¿å­˜é“¾è¡¨å¤´</td>
</tr>
<tr>
<td>Index Entry åŒºåŸŸ</td>
<td>æ¯ä¸ª Entry 20å­—èŠ‚ï¼Œä¿å­˜å®é™…çš„ç´¢å¼•è®°å½•</td>
</tr>
</tbody></table>
<h3 id="æ¯ä¸ªç´¢å¼•é¡¹ç»“æ„å¦‚ä¸‹ï¼ˆå…±20å­—èŠ‚ï¼‰ï¼š"><a href="#æ¯ä¸ªç´¢å¼•é¡¹ç»“æ„å¦‚ä¸‹ï¼ˆå…±20å­—èŠ‚ï¼‰ï¼š" class="headerlink" title="æ¯ä¸ªç´¢å¼•é¡¹ç»“æ„å¦‚ä¸‹ï¼ˆå…±20å­—èŠ‚ï¼‰ï¼š"></a>æ¯ä¸ªç´¢å¼•é¡¹ç»“æ„å¦‚ä¸‹ï¼ˆå…±20å­—èŠ‚ï¼‰ï¼š</h3><table>
<thead>
<tr>
<th>å­—èŠ‚æ•°</th>
<th>å­—æ®µ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>8</td>
<td>commitLogOffset</td>
<td>æ¶ˆæ¯åœ¨ CommitLog ä¸­çš„åç§»é‡</td>
</tr>
<tr>
<td>4</td>
<td>keyHash</td>
<td>Key çš„ Hash å€¼</td>
</tr>
<tr>
<td>4</td>
<td>timeDiff</td>
<td>ç›¸å¯¹äºæ–‡ä»¶å¼€å§‹æ—¶é—´çš„ç§’å·®å€¼</td>
</tr>
<tr>
<td>4</td>
<td>prevIndexOffset</td>
<td>ä¸Šä¸€ä¸ªç´¢å¼•é¡¹çš„ä½ç½®ï¼ˆæ„å»ºé“¾è¡¨ï¼‰</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ§¬-ç´¢å¼•æ„å»ºè¿‡ç¨‹"><a href="#ğŸ§¬-ç´¢å¼•æ„å»ºè¿‡ç¨‹" class="headerlink" title="ğŸ§¬ ç´¢å¼•æ„å»ºè¿‡ç¨‹"></a>ğŸ§¬ ç´¢å¼•æ„å»ºè¿‡ç¨‹</h2><p>å†™å…¥æ¶ˆæ¯åˆ° CommitLog åï¼Œå¦‚æœæ¶ˆæ¯è®¾ç½®äº† <code>key</code>ï¼Œåˆ™ RocketMQ ä¼šæ„å»ºç´¢å¼•ï¼š</p>
<ol>
<li><p><strong>è®¡ç®— key çš„ hashCode</strong></p>
</li>
<li><p><strong>å®šä½ Hash Slot</strong>ï¼š</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">slotPos = keyHash % hashSlotNum<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>è·å–å½“å‰ slot æŒ‡å‘çš„æœ€æ–°ç´¢å¼•é¡¹ä½ç½®ï¼ˆprevIndexOffsetï¼‰</strong></p>
</li>
<li><p><strong>åˆ›å»ºæ–°çš„ IndexEntryï¼Œå†™å…¥å½“å‰ commitLogOffsetã€timeDiffã€keyHashã€prevIndexOffset</strong></p>
</li>
<li><p><strong>æ›´æ–° Hash Slot çš„æŒ‡é’ˆä¸ºå½“å‰ Entry çš„ç´¢å¼•</strong></p>
</li>
</ol>
<p>å°±è¿™æ ·ï¼Œé€šè¿‡ <strong>slot + å•é“¾è¡¨</strong> å®ç° <strong>å¤š key å“ˆå¸Œå†²çªä¸‹çš„é“¾å¼ç´¢å¼•</strong>ã€‚</p>
<hr>
<h2 id="ğŸ”-æŸ¥è¯¢æ¶ˆæ¯æµç¨‹ï¼ˆé€šè¿‡-keyï¼‰"><a href="#ğŸ”-æŸ¥è¯¢æ¶ˆæ¯æµç¨‹ï¼ˆé€šè¿‡-keyï¼‰" class="headerlink" title="ğŸ” æŸ¥è¯¢æ¶ˆæ¯æµç¨‹ï¼ˆé€šè¿‡ keyï¼‰"></a>ğŸ” æŸ¥è¯¢æ¶ˆæ¯æµç¨‹ï¼ˆé€šè¿‡ keyï¼‰</h2><p>è°ƒç”¨ <code>MessageStore.lookMessageByKey(...)</code>ï¼š</p>
<ol>
<li><p>æ ¹æ® key è®¡ç®— hash å€¼</p>
</li>
<li><p>å®šä½ slot</p>
</li>
<li><p>éå†è¯¥ slot å¯¹åº”çš„é“¾è¡¨ï¼ˆæŒ‰ <code>prevIndexOffset</code>ï¼‰</p>
</li>
<li><p>æ‰¾åˆ°æ»¡è¶³æ—¶é—´èŒƒå›´çš„æ¶ˆæ¯åç§»é‡ï¼ˆcommitLogOffsetï¼‰</p>
</li>
<li><p>ä» CommitLog ä¸­è¯»å–å®é™…æ¶ˆæ¯å¹¶è¿”å›</p>
</li>
</ol>
<p><strong>æ³¨æ„</strong>ï¼šåªèƒ½æŸ¥æ‰¾æœ€è¿‘ 7 å¤©å†…çš„æ¶ˆæ¯ï¼ˆé»˜è®¤ Index æ–‡ä»¶ä¿ç•™æ—¶é•¿ä¸º 7 å¤©ï¼‰</p>
<hr>
<h2 id="â³-ç´¢å¼•æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†"><a href="#â³-ç´¢å¼•æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†" class="headerlink" title="â³ ç´¢å¼•æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†"></a>â³ ç´¢å¼•æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†</h2><ul>
<li><p>æ¯æ¬¡ Broker å¯åŠ¨æ—¶ä¼šåŠ è½½æœ¬åœ° index ç›®å½•ä¸­çš„ IndexFile</p>
</li>
<li><p>æ¯ä¸ªæ–‡ä»¶æœ€å¤šå­˜æ”¾ 2000 ä¸‡æ¡ç´¢å¼•ï¼Œå­˜æ»¡åè‡ªåŠ¨åˆ›å»ºæ–°æ–‡ä»¶</p>
</li>
<li><p>æ¯ä¸ªæ–‡ä»¶å‘½åä¸ºåˆ›å»ºæ—¶é—´æˆ³ï¼ˆ<code>index-YYYYMMDDHHMMSS</code>ï¼‰</p>
</li>
<li><p>å®šæœŸæ¸…ç†è¿‡æœŸ IndexFileï¼ˆé…åˆæ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸï¼‰</p>
</li>
</ul>
<hr>
<h2 id="ğŸš¦-å®é™…ä½¿ç”¨æ³¨æ„äº‹é¡¹"><a href="#ğŸš¦-å®é™…ä½¿ç”¨æ³¨æ„äº‹é¡¹" class="headerlink" title="ğŸš¦ å®é™…ä½¿ç”¨æ³¨æ„äº‹é¡¹"></a>ğŸš¦ å®é™…ä½¿ç”¨æ³¨æ„äº‹é¡¹</h2><table>
<thead>
<tr>
<th>é¡¹ç›®</th>
<th>å»ºè®®</th>
</tr>
</thead>
<tbody><tr>
<td>æ˜¯å¦å¼€å¯æ¶ˆæ¯ key</td>
<td>ä»…å¯¹éœ€è¦æŒ‰ key æŸ¥è¯¢çš„æ¶ˆæ¯è®¾ç½® key</td>
</tr>
<tr>
<td>æŸ¥è¯¢æ€§èƒ½å½±å“</td>
<td>ä»…æ”¯æŒç®€å• key ç´¢å¼•ï¼Œä¸æ”¯æŒå¤æ‚ SQL92 æŸ¥è¯¢</td>
</tr>
<tr>
<td>å­˜å‚¨ç©ºé—´æ¶ˆè€—</td>
<td>key å¤šä¼šå¯¼è‡´ IndexFile è†¨èƒ€</td>
</tr>
<tr>
<td>ä¸é€‚åˆåœºæ™¯</td>
<td>é¢‘ç¹ key æŸ¥è¯¢ã€ç´¢å¼•ä¿ç•™æ—¶é—´è¦æ±‚å¾ˆé•¿</td>
</tr>
</tbody></table>
<h1 id="RocketMQ-ç´¢å¼•æ–‡ä»¶ä¸­keyçš„è§£é‡Š"><a href="#RocketMQ-ç´¢å¼•æ–‡ä»¶ä¸­keyçš„è§£é‡Š" class="headerlink" title="RocketMQ ç´¢å¼•æ–‡ä»¶ä¸­keyçš„è§£é‡Š"></a><strong>RocketMQ ç´¢å¼•æ–‡ä»¶ä¸­keyçš„è§£é‡Š</strong></h1><h2 id="âœ…-ç®€å•å®šä¹‰"><a href="#âœ…-ç®€å•å®šä¹‰" class="headerlink" title="âœ… ç®€å•å®šä¹‰"></a>âœ… ç®€å•å®šä¹‰</h2><p><strong>Key æ˜¯ç”¨æˆ·ä¸ºæ¶ˆæ¯æŒ‡å®šçš„ä¸šåŠ¡æ ‡è¯†ç¬¦</strong>ï¼Œç”¨äº RocketMQ æ„å»ºç´¢å¼•ï¼ˆIndexFileï¼‰ï¼Œä»è€Œæ”¯æŒé€šè¿‡ key å¿«é€ŸæŸ¥æ‰¾æ¶ˆæ¯ã€‚</p>
<p>ä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯â€œæ¶ˆæ¯çš„ä¸šåŠ¡ä¸»é”®â€ã€‚</p>
<hr>
<h2 id="ğŸ“Œ-è®¾ç½®-Key-çš„æ–¹å¼"><a href="#ğŸ“Œ-è®¾ç½®-Key-çš„æ–¹å¼" class="headerlink" title="ğŸ“Œ è®¾ç½® Key çš„æ–¹å¼"></a>ğŸ“Œ è®¾ç½® Key çš„æ–¹å¼</h2><p>å½“ä½ å‘é€æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è®¾ç½® keyï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(<span class="hljs-string">&quot;TopicTest&quot;</span>, <span class="hljs-string">&quot;TagA&quot;</span>, <span class="hljs-string">&quot;order123456&quot;</span>, msgBody);<br>msg.setKeys(<span class="hljs-string">&quot;order123456&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ª <code>&quot;order123456&quot;</code> å°±æ˜¯ keyï¼Œå¯ä»¥æ˜¯ï¼š</p>
<ul>
<li><p>è®¢å•å·</p>
</li>
<li><p>ç”¨æˆ·ID</p>
</li>
<li><p>ä¸šåŠ¡æµæ°´å·</p>
</li>
<li><p>ä»»ä½•ä½ æƒ³æ—¥åè¿½è¸ª&#x2F;æŸ¥è¯¢çš„ä¸šåŠ¡æ ‡è¯†</p>
</li>
</ul>
<hr>
<h2 id="ğŸ§ -key-çš„ä½œç”¨"><a href="#ğŸ§ -key-çš„ä½œç”¨" class="headerlink" title="ğŸ§  key çš„ä½œç”¨"></a>ğŸ§  key çš„ä½œç”¨</h2><table>
<thead>
<tr>
<th>ä½œç”¨</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>ğŸ” æ¶ˆæ¯è¿½è¸ª</td>
<td>è¿ç»´&#x2F;ä¸šåŠ¡å¯é€šè¿‡ key æŸ¥è¯¢æ¶ˆæ¯è½¨è¿¹ï¼ˆæŸ¥è¯¢ã€æ¶ˆè´¹çŠ¶æ€ï¼‰</td>
</tr>
<tr>
<td>ğŸ§¾ æ—¥å¿—å®¡è®¡</td>
<td>è·Ÿè¸ªæŸä¸€ç¬”äº¤æ˜“&#x2F;äº‹ä»¶æ¶ˆæ¯åœ¨ç³»ç»Ÿä¸­æµè½¬æƒ…å†µ</td>
</tr>
<tr>
<td>ğŸ”— æ„å»ºç´¢å¼•ï¼ˆIndexFileï¼‰</td>
<td>RocketMQ ä¼šè‡ªåŠ¨ä¸ºè®¾ç½®äº† key çš„æ¶ˆæ¯ç”Ÿæˆç´¢å¼•æ–‡ä»¶</td>
</tr>
<tr>
<td>ğŸš¨ æ•…éšœæ¢å¤</td>
<td>æŸäº›å¼‚å¸¸åœºæ™¯ä¸‹å¯ä»¥é€šè¿‡ key é‡æ–°æ‰¾å›æ¶ˆæ¯</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ”„-å¤šä¸ª-key"><a href="#ğŸ”„-å¤šä¸ª-key" class="headerlink" title="ğŸ”„ å¤šä¸ª key"></a>ğŸ”„ å¤šä¸ª key</h2><p>ä½ å¯ä»¥è®¾ç½®å¤šä¸ª keyï¼Œç”¨ç©ºæ ¼éš”å¼€ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">msg.setKeys(<span class="hljs-string">&quot;order123 user456 session789&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>RocketMQ ä¼šä¸ºæ¯ä¸ª key å•ç‹¬åˆ›å»ºä¸€æ¡ç´¢å¼•è®°å½•ã€‚</p>
<hr>
<h2 id="âš ï¸-æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ æ³¨æ„äº‹é¡¹"></a>âš ï¸ æ³¨æ„äº‹é¡¹</h2><table>
<thead>
<tr>
<th>é¡¹ç›®</th>
<th>å»ºè®®&#x2F;è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>key ä¸æ˜¯æ¶ˆæ¯ ID</td>
<td>key æ˜¯ç”¨æˆ·ä¸šåŠ¡è®¾ç½®çš„æ ‡è¯†ï¼ŒmsgId æ˜¯ç³»ç»Ÿç”Ÿæˆçš„å…¨å±€å”¯ä¸€ID</td>
</tr>
<tr>
<td>key é•¿åº¦é™åˆ¶</td>
<td>å»ºè®®ä¸è¦å¤ªé•¿ï¼Œå¦åˆ™ä¼šå¢åŠ ç´¢å¼•æ–‡ä»¶å¤§å°</td>
</tr>
<tr>
<td>key ä¸ä¿è¯å”¯ä¸€</td>
<td>å¦‚æœä½ è®¾ç½®äº†é‡å¤çš„ keyï¼Œç´¢å¼•ä¼šè¿½åŠ ï¼Œä¸è¦†ç›–</td>
</tr>
<tr>
<td>key æŸ¥è¯¢æœ‰æ•ˆæœŸ</td>
<td>å— IndexFile çš„ä¿å­˜æ—¶é•¿å½±å“ï¼ˆé»˜è®¤ 7 å¤©ï¼‰</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ”§-ä½¿ç”¨-key-æŸ¥è¯¢æ¶ˆæ¯"><a href="#ğŸ”§-ä½¿ç”¨-key-æŸ¥è¯¢æ¶ˆæ¯" class="headerlink" title="ğŸ”§ ä½¿ç”¨ key æŸ¥è¯¢æ¶ˆæ¯"></a>ğŸ”§ ä½¿ç”¨ key æŸ¥è¯¢æ¶ˆæ¯</h2><p>ä½ å¯ä»¥é€šè¿‡ç®¡ç†æ§åˆ¶å°æˆ– API æŸ¥è¯¢æŸä¸ª key å¯¹åº”çš„æ¶ˆæ¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sh mqadmin queryMessage -n localhost:9876 -t TopicTest -k order123456<br></code></pre></td></tr></table></figure>

<p>æˆ–é€šè¿‡ Java APIï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">MessageExt</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> consumer.viewMessageByKey(<span class="hljs-string">&quot;TopicTest&quot;</span>, <span class="hljs-string">&quot;order123456&quot;</span>);<br></code></pre></td></tr></table></figure>
      </section>
      <section class="extra">
        
          <ul class="copyright">
  
    <li><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>å•çº¿ç¨‹åƒåœ¾æ¸…ç†å·¥</li>
    <li><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="https://rongxiaohan.github.io/2024/06/03/RocketMQ%E8%BF%9B%E9%98%B6%E4%B8%89%E4%B9%8B%E7%BB%84%E4%BB%B6%E8%A7%A3%E8%AF%BB/index.html" title="https:&#x2F;&#x2F;rongxiaohan.github.io&#x2F;2024&#x2F;06&#x2F;03&#x2F;RocketMQ%E8%BF%9B%E9%98%B6%E4%B8%89%E4%B9%8B%E7%BB%84%E4%BB%B6%E8%A7%A3%E8%AF%BB&#x2F;index.html">https:&#x2F;&#x2F;rongxiaohan.github.io&#x2F;2024&#x2F;06&#x2F;03&#x2F;RocketMQ%E8%BF%9B%E9%98%B6%E4%B8%89%E4%B9%8B%E7%BB%84%E4%BB%B6%E8%A7%A3%E8%AF%BB&#x2F;index.html</a></li>
    <li><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« å‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" title="BY-NC-SA" target="_blank" rel="noopener">BY-NC-SA</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</li>
  
</ul>
        
        
        
  <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketMQ/" rel="tag">RocketMQ</a></li></ul> 

        
  <nav class="nav">
    <a href="/2024/06/04/RocketMQ%E8%BF%9B%E9%98%B6%E5%9B%9B/"><i class="iconfont iconleft"></i>RocketMQè¿›é˜¶å››</a>
    <a href="/2024/06/02/RocketMQ%E8%BF%9B%E9%98%B6%E4%BA%8C/">RocketMQè¿›é˜¶äºŒ<i class="iconfont iconright"></i></a>
  </nav>

      </section>
      
    </section>
  </div>
</article></div>
      <div class="col-xl-3">
        
          
  <aside class="toc-wrap">
    <h3 class="toc-title">æ–‡ç« ç›®å½•ï¼š</h3>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ-NameServer%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%A2%B3%E7%90%86"><span class="toc-text">RocketMQ NameServerå¯åŠ¨è¿‡ç¨‹æ¢³ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A9-1-%E5%85%A5%E5%8F%A3%E7%B1%BB-NamesrvStartup-main"><span class="toc-text">ğŸ§© 1. å…¥å£ç±» NamesrvStartup.main()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%A7-2-%E5%88%9B%E5%BB%BA-NamesrvController"><span class="toc-text">ğŸ”§ 2. åˆ›å»º NamesrvController</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-3-NamesrvController-initialize"><span class="toc-text">âš™ï¸ 3. NamesrvController.initialize()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8F%81-4-NamesrvController-start"><span class="toc-text">ğŸ 4. NamesrvController.start()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%84-%E5%90%8E%E5%8F%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-text">ğŸ”„ åå°å®šæ—¶ä»»åŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%AA%9C-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93%E5%9B%BE"><span class="toc-text">ğŸªœ å¯åŠ¨æµç¨‹æ€»ç»“å›¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%92%A1-%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82%E8%A1%A5%E5%85%85"><span class="toc-text">ğŸ’¡ ä¸€äº›ç»†èŠ‚è¡¥å……</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF%E7%9A%84%E7%AE%A1%E7%90%86"><span class="toc-text">1. è·¯ç”±ä¿¡æ¯çš„ç®¡ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Broker-%E6%B3%A8%E5%86%8C%E5%8E%9F%E7%90%86"><span class="toc-text">2. Broker æ³¨å†ŒåŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9C%85-%E6%80%BB%E7%BB%93"><span class="toc-text">âœ… æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ-Broker%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%A2%B3%E7%90%86"><span class="toc-text">RocketMQ Brokerå¯åŠ¨è¿‡ç¨‹æ¢³ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%80-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E6%80%BB%E8%A7%88"><span class="toc-text">ğŸš€ å¯åŠ¨æµç¨‹æ€»è§ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A9-1-BrokerStartup-main"><span class="toc-text">ğŸ§© 1. BrokerStartup.main()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%99%EF%B8%8F-2-createBrokerController-args"><span class="toc-text">âš™ï¸ 2. createBrokerController(args)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%A7-3-BrokerController-initialize"><span class="toc-text">ğŸ”§ 3. BrokerController.initialize()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8F%81-4-BrokerController-start"><span class="toc-text">ğŸ 4. BrokerController.start()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%81-%E6%B3%A8%E5%86%8C%E5%88%B0-NameServer"><span class="toc-text">ğŸ” æ³¨å†Œåˆ° NameServer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">æ³¨å†Œåšäº†ä»€ä¹ˆï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%92%BE-%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6-DefaultMessageStore"><span class="toc-text">ğŸ’¾ æ¶ˆæ¯å­˜å‚¨ç»„ä»¶ DefaultMessageStore</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A0-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%80%BB%E7%BB%93"><span class="toc-text">ğŸ§  å¯åŠ¨æµç¨‹å›¾æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ-Netty%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%A1%86%E6%9E%B6"><span class="toc-text">RocketMQ NettyæœåŠ¡æ³¨å†Œæ¡†æ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%80-1-RocketMQ-%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%A1%86%E6%9E%B6%E7%BB%84%E6%88%90"><span class="toc-text">ğŸš€ 1. RocketMQ çš„æœåŠ¡æ³¨å†Œæ¡†æ¶ç»„æˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A9-2-NameServer-%E7%9A%84%E6%B3%A8%E5%86%8C%E6%9C%BA%E5%88%B6%EF%BC%88%E8%87%AA%E7%A0%94%EF%BC%89"><span class="toc-text">ğŸ§© 2. NameServer çš„æ³¨å†Œæœºåˆ¶ï¼ˆè‡ªç ”ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A0-3-Broker-%E6%B3%A8%E5%86%8C-NameServer-%E6%B5%81%E7%A8%8B%EF%BC%88%E5%9F%BA%E4%BA%8E-Netty%EF%BC%89"><span class="toc-text">ğŸ§  3. Broker æ³¨å†Œ NameServer æµç¨‹ï¼ˆåŸºäº Nettyï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Broker-%E5%90%AF%E5%8A%A8%E6%97%B6%E4%BC%9A%E5%AE%9A%E6%97%B6%E6%B3%A8%E5%86%8C%EF%BC%9A"><span class="toc-text">Broker å¯åŠ¨æ—¶ä¼šå®šæ—¶æ³¨å†Œï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E6%96%B9%E6%B3%95%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91%EF%BC%9A"><span class="toc-text">æ³¨å†Œæ–¹æ³•æ ¸å¿ƒé€»è¾‘ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%A7-4-Netty-%E5%9C%A8-RocketMQ-%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">ğŸ”§ 4. Netty åœ¨ RocketMQ ä¸­çš„ä½¿ç”¨æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9C%89%EF%B8%8F-5-%E6%B3%A8%E5%86%8C%E8%AF%B7%E6%B1%82%E5%8D%8F%E8%AE%AE%EF%BC%88REGISTER-BROKER%EF%BC%89"><span class="toc-text">âœ‰ï¸ 5. æ³¨å†Œè¯·æ±‚åè®®ï¼ˆREGISTER_BROKERï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%97%82%EF%B8%8F-6-NameServer-%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84%EF%BC%88%E6%B3%A8%E5%86%8C%E7%BB%93%E6%9E%9C%E7%9A%84%E8%90%BD%E5%9C%B0%EF%BC%89"><span class="toc-text">ğŸ—‚ï¸ 6. NameServer å†…å­˜ç»“æ„ï¼ˆæ³¨å†Œç»“æœçš„è½åœ°ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E5%B0%8F%E7%BB%93%EF%BC%9ARocketMQ-%E8%87%AA%E7%A0%94%E7%9A%84-Netty-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E6%A1%86%E6%9E%B6"><span class="toc-text">ğŸ¯ å°ç»“ï¼šRocketMQ è‡ªç ”çš„ Netty æœåŠ¡æ³¨å†Œæ¡†æ¶</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ-Broker%E5%BF%83%E8%B7%B3%E6%B3%A8%E5%86%8C%E7%AE%A1%E7%90%86"><span class="toc-text">RocketMQ Brokerå¿ƒè·³æ³¨å†Œç®¡ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%AF-%E7%9B%AE%E6%A0%87%EF%BC%9ABroker-%E5%92%8C-NameServer-%E5%A6%82%E4%BD%95%E4%BF%9D%E6%8C%81%E2%80%9C%E5%9C%A8%E7%BA%BF%E6%84%9F%E7%9F%A5%E2%80%9D"><span class="toc-text">ğŸ¯ ç›®æ ‡ï¼šBroker å’Œ NameServer å¦‚ä½•ä¿æŒâ€œåœ¨çº¿æ„ŸçŸ¥â€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A9-%E4%B8%80%E3%80%81Broker-%E5%AE%9A%E6%97%B6%E6%B3%A8%E5%86%8C%E6%9C%BA%E5%88%B6%EF%BC%88%E5%BF%83%E8%B7%B3%E5%BC%8F%E6%B3%A8%E5%86%8C%EF%BC%89"><span class="toc-text">ğŸ§© ä¸€ã€Broker å®šæ—¶æ³¨å†Œæœºåˆ¶ï¼ˆå¿ƒè·³å¼æ³¨å†Œï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%BB%BB%E5%8A%A1%E5%9C%A8-Broker-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%97%B6%E8%AE%BE%E7%BD%AE%EF%BC%9A"><span class="toc-text">æ³¨å†Œä»»åŠ¡åœ¨ Broker åˆå§‹åŒ–æ—¶è®¾ç½®ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AF%8F-30-%E7%A7%92-%E5%90%91%E6%89%80%E6%9C%89-NameServer-%E5%8F%91%E9%80%81-REGISTER-BROKER-%E8%AF%B7%E6%B1%82"><span class="toc-text">æ¯ 30 ç§’ å‘æ‰€æœ‰ NameServer å‘é€ REGISTER_BROKER è¯·æ±‚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A0-%E4%BA%8C%E3%80%81NameServer-%E5%A4%84%E7%90%86%E6%B3%A8%E5%86%8C%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-text">ğŸ§  äºŒã€NameServer å¤„ç†æ³¨å†Œçš„æµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%81-%E4%B8%89%E3%80%81%E5%BF%83%E8%B7%B3%E8%B6%85%E6%97%B6%E6%A3%80%E6%9F%A5%EF%BC%88NameServer-%E6%B8%85%E7%90%86%E6%AD%BB%E6%8E%89%E7%9A%84-Broker%EF%BC%89"><span class="toc-text">ğŸ” ä¸‰ã€å¿ƒè·³è¶…æ—¶æ£€æŸ¥ï¼ˆNameServer æ¸…ç†æ­»æ‰çš„ Brokerï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4%EF%BC%9A"><span class="toc-text">é»˜è®¤è¿‡æœŸæ—¶é—´ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%97%82%EF%B8%8F-%E5%9B%9B%E3%80%81%E6%A0%B8%E5%BF%83%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84%EF%BC%88RouteInfoManager%EF%BC%89"><span class="toc-text">ğŸ—‚ï¸ å››ã€æ ¸å¿ƒå†…å­˜ç»“æ„ï¼ˆRouteInfoManagerï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%AA-%E4%BA%94%E3%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B7%AF%E7%94%B1%E6%9F%A5%E8%AF%A2%E4%B8%8E%E5%AE%B9%E7%81%BE"><span class="toc-text">ğŸ§ª äº”ã€å®¢æˆ·ç«¯è·¯ç”±æŸ¥è¯¢ä¸å®¹ç¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9C%85-%E6%80%BB%E7%BB%93%E4%B8%80%E5%8F%A5%E8%AF%9D%EF%BC%9A"><span class="toc-text">âœ… æ€»ç»“ä¸€å¥è¯ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%8C-%E8%A1%A5%E5%85%85%EF%BC%9A%E4%B8%BB%E4%BB%8E-Broker-%E7%9A%84%E6%B3%A8%E5%86%8C%E5%B7%AE%E5%BC%82"><span class="toc-text">ğŸ“Œ è¡¥å……ï¼šä¸»ä» Broker çš„æ³¨å†Œå·®å¼‚</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ-Producer%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E8%BF%87%E7%A8%8B%E8%A7%A3%E8%AF%BB"><span class="toc-text">RocketMQ Producerå‘é€æ¶ˆæ¯è¿‡ç¨‹è§£è¯»</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Producer-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%85%A5%E5%8F%A3"><span class="toc-text">1. Producer å‘é€æ¶ˆæ¯çš„å…¥å£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%B7%AF%E7%94%B1%E8%8E%B7%E5%8F%96%EF%BC%88%E5%90%91-NameServer-%E6%8B%89%E5%8F%96-Topic-%E8%B7%AF%E7%94%B1%EF%BC%89"><span class="toc-text">2. è·¯ç”±è·å–ï¼ˆå‘ NameServer æ‹‰å– Topic è·¯ç”±ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%80%89%E6%8B%A9%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%88%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%89"><span class="toc-text">3. é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%EF%BC%88%E8%B0%83%E7%94%A8%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%EF%BC%89"><span class="toc-text">4. å‘é€æ¶ˆæ¯ï¼ˆè°ƒç”¨ç½‘ç»œé€šä¿¡ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%8F%91%E9%80%81%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8"><span class="toc-text">4.1 å‘é€æ¥å£è°ƒç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82%E6%9E%84%E9%80%A0%EF%BC%88RemotingCommand%EF%BC%89"><span class="toc-text">4.2 å‘é€è¯·æ±‚æ„é€ ï¼ˆRemotingCommandï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E9%80%9A%E8%BF%87-Netty-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-text">4.3 é€šè¿‡ Netty å‘é€æ¶ˆæ¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Broker-%E6%8E%A5%E6%94%B6%E5%B9%B6%E5%A4%84%E7%90%86%E6%B6%88%E6%81%AF"><span class="toc-text">5. Broker æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Producer-%E6%8E%A5%E6%94%B6%E5%93%8D%E5%BA%94"><span class="toc-text">6. Producer æ¥æ”¶å“åº”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%A4%B1%E8%B4%A5%E9%87%8D%E8%AF%95%E5%92%8C%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-text">7. å¤±è´¥é‡è¯•å’Œäº‹åŠ¡æ¶ˆæ¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%9D-%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93%E5%9B%BE"><span class="toc-text">ğŸ“ æµç¨‹æ€»ç»“å›¾</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ-Consumer%E6%8B%89%E5%8F%96%E6%B6%88%E6%81%AF%E8%BF%87%E7%A8%8B%E8%A7%A3%E8%AF%BB"><span class="toc-text">RocketMQ Consumeræ‹‰å–æ¶ˆæ¯è¿‡ç¨‹è§£è¯»</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Consumer-%E5%90%AF%E5%8A%A8%E8%AE%A2%E9%98%85%E6%B5%81%E7%A8%8B"><span class="toc-text">1. Consumer å¯åŠ¨è®¢é˜…æµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%8B%89%E5%8F%96%E6%B6%88%E6%81%AF%E8%A7%A6%E5%8F%91%E7%82%B9"><span class="toc-text">2. æ‹‰å–æ¶ˆæ¯è§¦å‘ç‚¹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%8E%B7%E5%8F%96-Topic-%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF"><span class="toc-text">3. è·å– Topic è·¯ç”±ä¿¡æ¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%8B%89%E5%8F%96%E6%B6%88%E6%81%AF%E8%AF%B7%E6%B1%82%E6%9E%84%E9%80%A0"><span class="toc-text">4. æ‹‰å–æ¶ˆæ¯è¯·æ±‚æ„é€ </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%8F%91%E9%80%81%E6%8B%89%E5%8F%96%E8%AF%B7%E6%B1%82%EF%BC%88Netty-%E9%80%9A%E4%BF%A1%EF%BC%89"><span class="toc-text">5. å‘é€æ‹‰å–è¯·æ±‚ï¼ˆNetty é€šä¿¡ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Broker-%E5%A4%84%E7%90%86%E6%8B%89%E5%8F%96%E8%AF%B7%E6%B1%82"><span class="toc-text">6. Broker å¤„ç†æ‹‰å–è¯·æ±‚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Consumer-%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF"><span class="toc-text">7. Consumer æ¥æ”¶æ¶ˆæ¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E6%B6%88%E8%B4%B9%E8%BF%9B%E5%BA%A6%E6%8F%90%E4%BA%A4%EF%BC%88offset-%E7%AE%A1%E7%90%86%EF%BC%89"><span class="toc-text">8. æ¶ˆè´¹è¿›åº¦æäº¤ï¼ˆoffset ç®¡ç†ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95%E5%92%8C%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86"><span class="toc-text">9. æ¶ˆæ¯é‡è¯•å’Œå¤±è´¥å¤„ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%9D-%E6%8B%89%E5%8F%96%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B%E7%AE%80%E5%8C%96%E5%9B%BE"><span class="toc-text">ğŸ“ æ‹‰å–æ¶ˆæ¯æµç¨‹ç®€åŒ–å›¾</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ-%E6%B6%88%E6%81%AF%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6%E4%BB%8B%E7%BB%8D"><span class="toc-text">RocketMQ æ¶ˆæ¯æŒä¹…åŒ–æœºåˆ¶ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-RocketMQ-%E6%8C%81%E4%B9%85%E5%8C%96%E6%A6%82%E8%BF%B0"><span class="toc-text">1. RocketMQ æŒä¹…åŒ–æ¦‚è¿°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%A0%B8%E5%BF%83%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6"><span class="toc-text">2. æ ¸å¿ƒå­˜å‚¨ç»„ä»¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-CommitLog-%E8%AF%A6%E8%A7%A3"><span class="toc-text">3. CommitLog è¯¦è§£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%B6%88%E6%81%AF%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B"><span class="toc-text">4. æ¶ˆæ¯å†™å…¥æµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-ConsumeQueue-%E7%B4%A2%E5%BC%95%E6%9C%BA%E5%88%B6"><span class="toc-text">5. ConsumeQueue ç´¢å¼•æœºåˆ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%B6%88%E6%81%AF%E5%88%B7%E7%9B%98%E7%AD%96%E7%95%A5"><span class="toc-text">6. æ¶ˆæ¯åˆ·ç›˜ç­–ç•¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E9%AB%98%E5%8F%AF%E7%94%A8%E5%A4%8D%E5%88%B6%EF%BC%88Broker-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%EF%BC%89"><span class="toc-text">7. é«˜å¯ç”¨å¤åˆ¶ï¼ˆBroker ä¸»ä»å¤åˆ¶ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E6%B8%85%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-text">8. æ¸…ç†ç­–ç•¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%9D-%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84%E7%AE%80%E5%9B%BE"><span class="toc-text">ğŸ“ å­˜å‚¨ç»“æ„ç®€å›¾</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ-CommitLog%E5%86%99%E5%85%A5%E8%BF%87%E7%A8%8B%E8%A7%A3%E8%AF%BB"><span class="toc-text">RocketMQ CommitLogå†™å…¥è¿‡ç¨‹è§£è¯»</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%86%99%E5%85%A5%E5%85%A5%E5%8F%A3"><span class="toc-text">1. å†™å…¥å…¥å£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%96%87%E4%BB%B6%E9%80%89%E6%8B%A9"><span class="toc-text">2. æ–‡ä»¶é€‰æ‹©</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%B6%88%E6%81%AF%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">3. æ¶ˆæ¯åºåˆ—åŒ–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%A1%BA%E5%BA%8F%E5%86%99%E5%85%A5%EF%BC%88MappedFile%EF%BC%89"><span class="toc-text">4. é¡ºåºå†™å…¥ï¼ˆMappedFileï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%BF%BD%E5%8A%A0%E5%86%99%E5%85%A5%E7%BB%93%E6%9E%9C"><span class="toc-text">5. è¿½åŠ å†™å…¥ç»“æœ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%88%B7%E7%9B%98%E6%9C%BA%E5%88%B6%EF%BC%88Flush%EF%BC%89"><span class="toc-text">6. åˆ·ç›˜æœºåˆ¶ï¼ˆFlushï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%B6%88%E6%81%AF%E7%B4%A2%E5%BC%95%E6%9E%84%E5%BB%BA"><span class="toc-text">7. æ¶ˆæ¯ç´¢å¼•æ„å»º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%9D-CommitLog-%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B%E7%A4%BA%E6%84%8F%E5%9B%BE"><span class="toc-text">ğŸ“ CommitLog å†™å…¥æµç¨‹ç¤ºæ„å›¾</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ-%E7%B4%A2%E5%BC%95%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E8%BF%87%E7%A8%8B%E8%A7%A3%E8%AF%BB"><span class="toc-text">RocketMQ ç´¢å¼•æ–‡ä»¶ç®¡ç†è¿‡ç¨‹è§£è¯»</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%8D-%E4%BB%80%E4%B9%88%E6%98%AF-IndexFile%EF%BC%9F"><span class="toc-text">ğŸ” ä»€ä¹ˆæ˜¯ IndexFileï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%81-%E7%B4%A2%E5%BC%95%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-text">ğŸ“ ç´¢å¼•æ–‡ä»¶ç»“æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AF%8F%E4%B8%AA%E7%B4%A2%E5%BC%95%E9%A1%B9%E7%BB%93%E6%9E%84%E5%A6%82%E4%B8%8B%EF%BC%88%E5%85%B120%E5%AD%97%E8%8A%82%EF%BC%89%EF%BC%9A"><span class="toc-text">æ¯ä¸ªç´¢å¼•é¡¹ç»“æ„å¦‚ä¸‹ï¼ˆå…±20å­—èŠ‚ï¼‰ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%AC-%E7%B4%A2%E5%BC%95%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-text">ğŸ§¬ ç´¢å¼•æ„å»ºè¿‡ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%8E-%E6%9F%A5%E8%AF%A2%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B%EF%BC%88%E9%80%9A%E8%BF%87-key%EF%BC%89"><span class="toc-text">ğŸ” æŸ¥è¯¢æ¶ˆæ¯æµç¨‹ï¼ˆé€šè¿‡ keyï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%8F%B3-%E7%B4%A2%E5%BC%95%E6%96%87%E4%BB%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86"><span class="toc-text">â³ ç´¢å¼•æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%A6-%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">ğŸš¦ å®é™…ä½¿ç”¨æ³¨æ„äº‹é¡¹</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ-%E7%B4%A2%E5%BC%95%E6%96%87%E4%BB%B6%E4%B8%ADkey%E7%9A%84%E8%A7%A3%E9%87%8A"><span class="toc-text">RocketMQ ç´¢å¼•æ–‡ä»¶ä¸­keyçš„è§£é‡Š</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9C%85-%E7%AE%80%E5%8D%95%E5%AE%9A%E4%B9%89"><span class="toc-text">âœ… ç®€å•å®šä¹‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%8C-%E8%AE%BE%E7%BD%AE-Key-%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-text">ğŸ“Œ è®¾ç½® Key çš„æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A0-key-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">ğŸ§  key çš„ä½œç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%84-%E5%A4%9A%E4%B8%AA-key"><span class="toc-text">ğŸ”„ å¤šä¸ª key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%9A%A0%EF%B8%8F-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">âš ï¸ æ³¨æ„äº‹é¡¹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%A7-%E4%BD%BF%E7%94%A8-key-%E6%9F%A5%E8%AF%A2%E6%B6%88%E6%81%AF"><span class="toc-text">ğŸ”§ ä½¿ç”¨ key æŸ¥è¯¢æ¶ˆæ¯</span></a></li></ol></li></ol>
  </aside>

        
      </div>
    </div>
  </div>
</main>
  

<footer class="footer">
  <div class="footer-social"><a 
        href="tencent://message/?Menu=yes&uin=894519210 "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#12B7F5'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconQQ "></i>
      </a><a 
        href="javascript:; "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#09BB07'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconwechat-fill "></i>
      </a><a 
        href="https://www.instagram.com/izhaoo/ "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#DA2E76'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconinstagram "></i>
      </a><a 
        href="https://github.com/zhaoo "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color= '#9f7be1'" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  icongithub-fill "></i>
      </a><a 
        href="mailto:izhaoo@163.com "
        target="_blank"
        class="footer-social-item"
        onMouseOver="this.style.color=#FF3B00" 
        onMouseOut="this.style.color='#33333D'">
          <i class="iconfont  iconmail"></i>
      </a></div>
  
    <div class="footer-copyright"><p></p></div>
  
</footer>
  
      <div class="fab fab-plus">
    <i class="iconfont iconplus"></i>
  </div>
  
  
  
  <div class="fab fab-up">
    <i class="iconfont iconcaret-up"></i>
  </div>
  
  
    <div class="scrollbar j-scrollbar">
  <div class="scrollbar-current j-scrollbar-current"></div>
</div>
  
  
    
<script src="/js/color-mode.js"></script>

  
  
</body>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>





  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>




  
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>






  
<script src="https://cdn.bootcdn.net/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>




<script src="/js/utils.js"></script>
<script src="/js/script.js"></script>







  <script>
    (function () {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>












</html>